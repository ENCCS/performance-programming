<!DOCTYPE html>
<html class="writer-html5" lang="en">
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Tuning &mdash; Performance Engineering  documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css" />
      <link rel="stylesheet" type="text/css" href="../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
      <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
      <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
      <link rel="stylesheet" type="text/css" href="../_static/sphinx_lesson.css" />
      <link rel="stylesheet" type="text/css" href="../_static/term_role_formatting.css" />
      <link rel="stylesheet" type="text/css" href="../_static/sphinx_rtd_theme_ext_color_contrast.css" />
      <link rel="stylesheet" type="text/css" href="../_static/tabs.css" />
      <link rel="stylesheet" type="text/css" href="../_static/overrides.css" />

  
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/sphinx_highlight.js"></script>
        <script src="../_static/clipboard.min.js"></script>
        <script src="../_static/copybutton.js"></script>
        <script src="../_static/minipres.js"></script>
        <script>let toggleHintShow = 'Click to show';</script>
        <script>let toggleHintHide = 'Click to hide';</script>
        <script>let toggleOpenOnPrint = 'true';</script>
        <script src="../_static/togglebutton.js"></script>
        <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
        <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
        <script src="../_static/tabs.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex/" />
    <link rel="search" title="Search" href="../search/" />
    <link rel="next" title="Quick Reference" href="../quick-reference/" />
    <link rel="prev" title="Architecture" href="../architecture/" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../" class="icon icon-home">
            Performance Engineering
              <img src="../_static/ENCCS.jpg" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search/" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Before The Lesson</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../setup/">Setup</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">The lesson</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../algorithms/">Algorithms</a></li>
<li class="toctree-l1"><a class="reference internal" href="../compilers/">Compilers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../architecture/">Architecture</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Tuning</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#matrix-matrix-multiplication">Matrix-matrix multiplication</a></li>
<li class="toctree-l2"><a class="reference internal" href="#daxpy">DAXPY</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#vectorization">Vectorization</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#blocking-for-registers">Blocking for registers</a></li>
<li class="toctree-l2"><a class="reference internal" href="#blocking-for-the-cache">Blocking for the cache</a></li>
<li class="toctree-l2"><a class="reference internal" href="#explicit-vectorization">Explicit vectorization</a></li>
<li class="toctree-l2"><a class="reference internal" href="#further-reads">Further reads</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../quick-reference/">Quick Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../glossary/">Glossary</a></li>
<li class="toctree-l1"><a class="reference internal" href="../guide/">Instructor’s guide</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../">Performance Engineering</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Tuning</li>
      <li class="wy-breadcrumbs-aside">
              <a href="https://github.com/ENCCS/content/blob/main/content/tuning.rst" class="fa fa-github"> Edit on GitHub</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="tuning">
<h1>Tuning<a class="headerlink" href="#tuning" title="Permalink to this heading"></a></h1>
<p>We will now combine what we have learnt and apply it to the problem of tuning the
well known matrix multiplication algorithm. Matrix multiplication has several
advanatges as an example, including:</p>
<ul class="simple">
<li><p>It is well known and relatively simple (a few lines at our starting point).</p></li>
<li><p>It is eminently tunable, as we will see. There is quite a difference in
performance between and a heavily tuned version (that is why you probably
use a library for this operation).</p></li>
<li><p>It is used in many contexts, as are algorithms with a similar structure such as
convolutions.</p></li>
<li><p>It probably consumes more compute cycles than (almost) any other given that it
is what powers large language models such as GPT-4 or GPT-5. Transformers, as the underlying
neural network architecture is called, consist almost entirely of matrix
multiplications.</p></li>
</ul>
<div class="admonition-the-roofline-model admonition">
<p class="admonition-title">The Roofline model</p>
<p>There are several ways to measure performance and, in this course, we have mostly used
execution time as a reference. In practice, however, time is not always the best metric for analysis,
as it abstracts away many layers of what is happening during the execution of an algorithm.</p>
<p>A popular alternative for evaluating how application kernels perform is the Roofline Model. As the name
suggests, it is a performance model that defines two major upper limits (or rooflines) for an application:
memory bandwidth and peak computational performance (operations per second). The idea behind the model is
that the slowest limiting factor, whether it is data transfer or computation throughput, dictates the overall performance.
Therefore, an application can be classified as memory-bound or compute-bound based on where it falls in the model.</p>
<p>More advanced versions of the Roofline Model also take into account additional factors such as cache hierarchies and SIMD
extensions (e.g., Fused Multiply-Add, or FMA). This is, for example, what the Intel Advisor Roofline analysis tool provides:
in the plot below, each dot represents a loop or function from the application, and multiple ceilings are shown. The farther
a kernel is from the corresponding ceiling, the greater the potential for optimization</p>
<figure class="align-default" id="id1">
<img alt="../_images/intel-roofline.png" src="../_images/intel-roofline.png" />
<figcaption>
<p><span class="caption-text">Diagonal lines represent how many bytes of data a given memory subsystem can deliver per second.
Horizontal lines represent the number of floating-point operations the hardware can perform in a given time interval.
Source: Intel Corporation.</span><a class="headerlink" href="#id1" title="Permalink to this image"></a></p>
</figcaption>
</figure>
<p>Among other commonly used tools for performing a roofline model of the hardware, there is the <a class="reference external" href="https://www.cs.virginia.edu/stream/">STREAM benchmark</a>
and <a class="reference external" href="https://github.com/RRZE-HPC/likwid">Likwid</a>. However, as this course does not focus on performance modeling in depth, the Roofline Model will not be discussed in depth here.</p>
<p>For further details, please refer to the “Further Reads” section of this lesson.</p>
</div>
<section id="matrix-matrix-multiplication">
<h2>Matrix-matrix multiplication<a class="headerlink" href="#matrix-matrix-multiplication" title="Permalink to this heading"></a></h2>
<p>Here is a naive matrix multiply with the same structure as the classic definition. The
outer two loops iterate over the result array while the innermost loop computes the
sum.</p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-0-0-0" aria-selected="true" class="sphinx-tabs-tab" id="tab-0-0-0" name="0-0" role="tab" tabindex="0">C</button><button aria-controls="panel-0-0-1" aria-selected="false" class="sphinx-tabs-tab" id="tab-0-0-1" name="0-1" role="tab" tabindex="-1">Fortran</button></div><div aria-labelledby="tab-0-0-0" class="sphinx-tabs-panel" id="panel-0-0-0" name="0-0" role="tabpanel" tabindex="0"><div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="kt">void</span><span class="w"> </span><span class="nf">matmul</span><span class="p">(</span><span class="kt">double</span><span class="o">*</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="kt">double</span><span class="o">*</span><span class="w"> </span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="kt">double</span><span class="o">*</span><span class="w"> </span><span class="n">c</span><span class="p">,</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos"> 2</span><span class="w">  </span><span class="k">for</span><span class="p">(</span><span class="kt">long</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">n</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos"> 3</span><span class="w">    </span><span class="k">for</span><span class="p">(</span><span class="kt">long</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">n</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos"> 4</span><span class="w">      </span><span class="kt">double</span><span class="w"> </span><span class="n">sum</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos"> 5</span><span class="w">      </span><span class="k">for</span><span class="p">(</span><span class="kt">long</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">n</span><span class="p">;</span><span class="w"> </span><span class="n">k</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos"> 6</span><span class="w">        </span><span class="n">sum</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">b</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="n">n</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">k</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">c</span><span class="p">[</span><span class="n">k</span><span class="o">*</span><span class="n">n</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">j</span><span class="p">];</span>
<span class="linenos"> 7</span><span class="w">      </span><span class="p">}</span>
<span class="linenos"> 8</span><span class="w">      </span><span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="n">n</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">j</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sum</span><span class="p">;</span>
<span class="linenos"> 9</span><span class="w">    </span><span class="p">}</span>
<span class="linenos">10</span><span class="w">  </span><span class="p">}</span>
<span class="linenos">11</span><span class="p">}</span>
</pre></div>
</div>
</div><div aria-labelledby="tab-0-0-1" class="sphinx-tabs-panel" hidden="true" id="panel-0-0-1" name="0-1" role="tabpanel" tabindex="0"><div class="highlight-fortran notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="k">module </span><span class="n">matmul_module</span>
<span class="linenos"> 2</span><span class="w">  </span><span class="k">use </span><span class="n">rtvl_module</span>
<span class="linenos"> 3</span><span class="w">  </span><span class="k">implicit none</span>
<span class="linenos"> 4</span><span class="k">contains</span>
<span class="linenos"> 5</span><span class="k">  subroutine </span><span class="nb">matmul</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="n">c</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">)</span>
<span class="linenos"> 6</span><span class="w">    </span><span class="k">use </span><span class="n">rtvl_module</span>
<span class="linenos"> 7</span><span class="w">    </span><span class="k">implicit none</span>
<span class="linenos"> 8</span><span class="k">    </span><span class="kt">integer</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">n</span>
<span class="linenos"> 9</span><span class="w">    </span><span class="kt">double precision</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">a</span><span class="p">(</span><span class="n">rtvl</span><span class="p">(</span><span class="n">n</span><span class="p">),</span><span class="n">n</span><span class="p">)</span>
<span class="linenos">10</span><span class="w">    </span><span class="kt">double precision</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">b</span><span class="p">(</span><span class="n">rtvl</span><span class="p">(</span><span class="n">n</span><span class="p">),</span><span class="n">n</span><span class="p">),</span><span class="w"> </span><span class="n">c</span><span class="p">(</span><span class="n">rtvl</span><span class="p">(</span><span class="n">n</span><span class="p">),</span><span class="n">n</span><span class="p">)</span>
<span class="linenos">11</span><span class="w">    </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">k</span>
<span class="linenos">12</span><span class="w">    </span><span class="kt">double precision</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="nb">sum</span>
<span class="linenos">13</span>
<span class="linenos">14</span><span class="nb">    </span><span class="k">do </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">n</span>
<span class="linenos">15</span><span class="w">      </span><span class="k">do </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">n</span>
<span class="linenos">16</span><span class="w">        </span><span class="nb">sum</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>
<span class="linenos">17</span><span class="w">        </span><span class="k">do </span><span class="n">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">n</span>
<span class="linenos">18</span><span class="w">          </span><span class="nb">sum</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">sum</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">b</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">c</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">j</span><span class="p">)</span>
<span class="linenos">19</span><span class="w">        </span><span class="k">end do</span>
<span class="linenos">20</span><span class="k">        </span><span class="n">a</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">sum</span>
<span class="linenos">21</span><span class="nb">      </span><span class="k">end do</span>
<span class="linenos">22</span><span class="k">    end do</span>
<span class="linenos">23</span><span class="k">  end subroutine </span><span class="nb">matmul</span>
<span class="linenos">24</span><span class="k">end module </span><span class="n">matmul_module</span>
</pre></div>
</div>
</div></div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This code uses explicit index calculations. For an <code class="docutils literal notranslate"><span class="pre">N</span> <span class="pre">x</span> <span class="pre">N</span></code> matrix <code class="docutils literal notranslate"><span class="pre">M</span></code> stored
in row major order, the element <code class="docutils literal notranslate"><span class="pre">M[i][j]</span></code> is stored at offset <code class="docutils literal notranslate"><span class="pre">i*N</span> <span class="pre">+</span> <span class="pre">j</span></code> from
the start of the (one dimensinal) array.</p>
<p>This is exactly how the C compiler implements multi dimensional arrays so if you
have</p>
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="kt">double</span><span class="w"> </span><span class="n">A</span><span class="p">[</span><span class="mi">100</span><span class="p">][</span><span class="mi">80</span><span class="p">];</span>
</pre></div>
</div>
<p>the reference <code class="docutils literal notranslate"><span class="pre">A[i][j]</span></code> will effectively be translated to
<code class="docutils literal notranslate"><span class="pre">A[i*80</span> <span class="pre">+</span> <span class="pre">j]</span></code>. This does not work if the compiler does not know the size of
the inner dimension (the row length), which is impossible since we want to
use the <code class="docutils literal notranslate"><span class="pre">matmul()</span></code> function for matrices of different size.</p>
</div>
<p>You can build this code using the following command:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>gcc<span class="w"> </span>-o<span class="w"> </span>mm<span class="w"> </span>ex-mm-ref.c<span class="w"> </span>ex-mm-main.c<span class="w"> </span>-lm
</pre></div>
</div>
<p>This gives you an executable program called <code class="docutils literal notranslate"><span class="pre">mm</span></code>.</p>
<div class="admonition-exercise exercise important admonition" id="exercise-0">
<p class="admonition-title">Exercise</p>
<p>Try running <code class="docutils literal notranslate"><span class="pre">mm</span></code> with different sized inputs and measure the execution time
using the <code class="docutils literal notranslate"><span class="pre">time</span></code> command. Sizes around 1000 should run in a few seconds.</p>
</div>
<div class="admonition-solution solution important dropdown admonition" id="solution-0">
<p class="admonition-title">Solution</p>
<p>On a T580 with a Core i7-8550U processor, I get the following:</p>
<img alt="../_images/mm1-times.png" class="align-center" src="../_images/mm1-times.png" />
<p>Same data in tabular form:</p>
<p>You can have a different shape to your curve; maybe it starts growing steeper
at some point. This likely depends on the memory hierarchy of your machine.</p>
</div>
<p>We know from inspecting the code that matrix multiplication is cubic in the size of
the matrix (for square matrices). Does that theory hold in practice as well?</p>
<div class="admonition-exercise exercise important admonition" id="exercise-1">
<p class="admonition-title">Exercise</p>
<p>Try to fit a cubic function (degree three polynomial) to the measurements in
the previous exercise.</p>
</div>
<div class="admonition-solution solution important dropdown admonition" id="solution-1">
<p class="admonition-title">Solution</p>
<p>On a T580 with a Core i7-8550U processor, the following results are seen:</p>
<img alt="../_images/mm1-times-c.png" class="align-center" src="../_images/mm1-times-c.png" />
<p>The fitting was done by hand, prioritizing the smaller matrix sizes since
the larger sizes likely have longer per-iteration times due to more
cache misses. The difference is not dramatic, though, as you can see.</p>
</div>
<p>The question then becomes: Is this a good result? Should we be satisfied and call it a
day or should we invest time and effort into trying to make the code faster?</p>
<p>One way to approach this question is to try to find a lower bound for the
possible execution time and comparing that lower bound to the observed performance.
Such a bound will often come from reasoning about the resources necessarily
consumed by the program.</p>
<p>What resources can be used to form this bound depends on what techniques one is
ready to use to increase performance. For instance, there are algorithms for
matrix multiplication that have a better complexity than <span class="math notranslate nohighlight">\(O(n^3)\)</span>, one
example being Strassen’s algorithm which is approximately <span class="math notranslate nohighlight">\(O(n^{2.8})\)</span>.
So if we are willing to switch algorithm, we cannot use the number of arithmetic
operations of our current program to compute our lower bound.</p>
<p>For the remainder of this chapter, we will keep the algorithm fixed, so the number
of arithmetic operations can be used to establish a lower bound. But what are those
arithmetic instructions? The obvious answer is that they are additions and
multiplications. However, most modern processors provide <code class="docutils literal notranslate"><span class="pre">fma</span></code> instructions
which compute <span class="math notranslate nohighlight">\(A = B + C \times D\)</span>, mapping very well to the
<code class="docutils literal notranslate"><span class="pre">sum</span> <span class="pre">+=</span> <span class="pre">...</span> <span class="pre">*</span> <span class="pre">...</span></code> of the inner loop of our program. Thus we will say that we
need to execute <span class="math notranslate nohighlight">\(N^3\)</span> <code class="docutils literal notranslate"><span class="pre">fma</span></code> operations.</p>
<p>So at what rate can a machine execute <code class="docutils literal notranslate"><span class="pre">fma</span></code> operations? That depends on
three different factors:</p>
<ul class="simple">
<li><p>SIMD width: Does the machine have SIMD <code class="docutils literal notranslate"><span class="pre">fma</span></code> instructions that performs
multiple operations in a single instruction, and if so, how many?</p></li>
<li><p>Instruction throughput: How many <code class="docutils literal notranslate"><span class="pre">fma</span></code> instructions can the machine execute
per cycle? If an <code class="docutils literal notranslate"><span class="pre">fma</span></code> takes more than a cycle, this number is less than
one.</p></li>
<li><p>Clock frequency: Given DVFS, the dynamic change of clock frequency to balance
power and performance depending on system load and other factors, there is no
simple number to plug in here.</p></li>
</ul>
<p>The SIMD width is a feature of the instruction set architecture amd can be found
in the relevant manuals. The throughput of the <code class="docutils literal notranslate"><span class="pre">fma</span></code> instruction is a feature of
the implementation, that is, the specific processor model. It is typically
documented in either an optimization manual or a hardware manual for that processor
model. As for the clock frequency, there is typically documentation about the
interval in which it falls, but that interval is generally wide, so that information
is of limited value.</p>
<p>We will handle the varying clock frequency by using the Linux <code class="docutils literal notranslate"><span class="pre">perf</span></code> tool to
measure the number of cycles the program executed rather than the elapsed time.
This is a good choice if the transformations we intend to do on the program
for the purpose of tuning do not affect the clock frequency. This may not always
be true, but in our experience it is close enough for the purpose of gauging the
room for improvement.</p>
<div class="admonition-example admonition">
<p class="admonition-title">Example</p>
<p>For the Core i7-8550U of the T580, the greatest SIMD width implemented is 256
bits (the AVX256 instruction set extension). Since the element type of the
matrix multiplication program is <code class="docutils literal notranslate"><span class="pre">double</span></code>, we have four elements per vector.</p>
<p>When it comes to the microarchitectures of common x86 implementations, one
of the best references is the <a class="reference external" href="https://www.agner.org/optimize/">web site</a>
maintained by the Danish scientist Agner Fog.
For the present purpose, we consult the
<a class="reference external" href="https://www.agner.org/optimize/instruction_tables.pdf">instruction table</a>
document. The Core i7-8550U is based on the Kaby Lake core which shares
microarchitecture with the preceeding Skylake core, so we check the entry for
the <code class="docutils literal notranslate"><span class="pre">VFMADD</span></code> instruction family in the Skylake tables.
In the <em>reciprocal throughput</em> column we find the value 0.5 which means
that the thoughput is 2 <code class="docutils literal notranslate"><span class="pre">VFMADD</span></code> family instructions per cycle.
The reciprocal throughput can be interpreted as the resource cost in cycles
of a <code class="docutils literal notranslate"><span class="pre">VFMADD</span></code> family instruction.</p>
<p>Putting these pieces of information together, we find that this processor
can do up to eight <code class="docutils literal notranslate"><span class="pre">fma</span></code> operations per cycle.</p>
</div>
<p>Next we need to figure out the number of cycles the program spends per (logical)
<code class="docutils literal notranslate"><span class="pre">fma</span></code> operation. Of course we have a rough idea since we found 3.1ns per
operation to be a good fit above and the clock frequency of our Core i7 will be
somewhere around 2.5 to 3.5 GHz giving an expected interval of 8-11 cycles.</p>
<div class="admonition-exercise exercise important admonition" id="exercise-2">
<p class="admonition-title">Exercise</p>
<p>Find the number of cycles by running <code class="docutils literal notranslate"><span class="pre">perf</span></code> as follows:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>perf<span class="w"> </span>stat<span class="w"> </span>./mm<span class="w"> </span>&lt;size&gt;
</pre></div>
</div>
</div>
<div class="admonition-solution solution important dropdown admonition" id="solution-2">
<p class="admonition-title">Solution</p>
<p>On the Core i7-8550U I get the following graph:</p>
<img alt="../_images/mm1-cpi.png" class="align-center" src="../_images/mm1-cpi.png" />
<p>Recall that the 3.1ns I fitted with above fell somewhat short of the
measured times for large sizes. This effect is immediately visible in
this graph: The cycle count rises from 9.5 or so to about 12 for the
largest sizes.</p>
</div>
<p>The conclusion is then that this version of the program is a factor
of a 80-100 from the lower bound, so a tuning effort is warranted.</p>
<p>An observation we can immediately make is that we forgot to turn on optimization
when we compiled the matrix multiplication program. Oops!</p>
<div class="admonition-exercise exercise important admonition" id="exercise-3">
<p class="admonition-title">Exercise</p>
<p>Explore how the performance in time or cycles changes with optimization
level. For GCC, interesting alternatives are <code class="docutils literal notranslate"><span class="pre">-O´´,</span> <span class="pre">``-O2</span></code> and <code class="docutils literal notranslate"><span class="pre">-O3</span></code>.
There are also more specialized flags which are sometimes useful.</p>
</div>
<div class="admonition-solution solution important dropdown admonition" id="solution-3">
<p class="admonition-title">Solution</p>
<p>On the Core i7-8550U I get the following graph:</p>
<img alt="../_images/mm1opt-cpi.png" class="align-center" src="../_images/mm1opt-cpi.png" />
<p>If you think that some of the graphs were not rendered: All of the optimization
levels give identical results. If you look closely, the lower graph shimmers
a bit here and there.</p>
</div>
<p>So, we got quite a boost from turning on optimization, as expected given all of
the index calculations in the source code. At this point, the best thing to do is
to try to understand the performance we have as far as possible before trying to
improve it. What barriers do we have to overcome to get further?</p>
<p>The first step here is to think about our program in the context of what we know
of the machine that is executing it and formulating some hypotheses regarding
what happens.</p>
<div class="admonition-exercise exercise important admonition" id="exercise-4">
<p class="admonition-title">Exercise</p>
<p>Take a moment to think about potential performance limiters in the code. You
may want to start from the simple performance equation:</p>
<p><span class="math notranslate nohighlight">\(N_C = N_I \times CPI\)</span></p>
<p>Also, what hints do we get from the shape of the graphs?</p>
</div>
<div class="admonition-solution solution important dropdown admonition" id="solution-4">
<p class="admonition-title">Solution</p>
<p>After collecting our thoughts, we have the following points:</p>
<ul class="simple">
<li><p>[CPI] Cache misses. Our matrices are large compared to the caches. Even the
smallest size matrix I have profiled is 180 000 bytes and we have three of
them. So one matrix does not fit in the L1 data cache (32K) and the three
of them together is larger than the L2 cache (256K). The 600 by 600 matrices
do not fit all at the same time even in the L3 cache (8M). This also fits
well with the increase in cycle count as the matrix size increases.</p></li>
<li><p>[CPI] Bad spatial locality: the reference to <code class="docutils literal notranslate"><span class="pre">c</span></code> has a stride equal to the
matrix dimension so nearby references are guaranteed to fall in different
cache lines.</p></li>
<li><p>[CPI] Arithmetic latency: The innermost loop sums the result and the trip
count is
large enough to exhaust the instruction window, so if the floating
point addition has N cycles of latency, we will have at least N cycles
per (logical) <code class="docutils literal notranslate"><span class="pre">fma</span></code>.</p></li>
<li><p>[<span class="math notranslate nohighlight">\(N_I\)</span>] The lower bound assumes that the arithmetics is performed using
four-way
SIMD vectorized <code class="docutils literal notranslate"><span class="pre">fma</span></code> instructions. Unvectorized separate <code class="docutils literal notranslate"><span class="pre">mul</span></code> and
<code class="docutils literal notranslate"><span class="pre">add</span></code> instructions require eight times as many instructions.</p></li>
<li><p>[CPI and <span class="math notranslate nohighlight">\(N_I\)</span>] The source code has two array accesses per logical
<code class="docutils literal notranslate"><span class="pre">fma</span></code>, one for the
<code class="docutils literal notranslate"><span class="pre">b</span></code> matrix and one for <code class="docutils literal notranslate"><span class="pre">c</span></code>. On an x86, arithmetic instructions can have
one memory operand, reducing the increase in instruction count. However,
such instructions generate two uops, making them effectively as expensive
as two instructions.</p></li>
</ul>
</div>
<p>Now that we have a few hypotheses, we know what to look for so the next steps
are:</p>
<ul class="simple">
<li><p>Look at the generated code, to see if there is anything surprising. We will only
be interested in the innermost loop, and there we expect to see the two memory
references, the arithmetic (separate <code class="docutils literal notranslate"><span class="pre">mul</span></code> and <code class="docutils literal notranslate"><span class="pre">add</span></code> or an <code class="docutils literal notranslate"><span class="pre">fma</span></code>),
uppdates to the pointers (will be separate because of the different strides),
and finally loop control in the form of a compare and a conditional branch.</p></li>
<li><p>Use <code class="docutils literal notranslate"><span class="pre">perf</span></code> again to get the CPI value (reported as IPC since it is expected
that there are more instructions than cycles). We can also use the tool to
verify that there are really many cache misses and we can get an estimate
of how these impact performance.</p></li>
</ul>
<p>Here are the example values as for my machine:</p>
<div class="admonition-example admonition">
<p class="admonition-title">Example</p>
<blockquote>
<div><p>Assembly for the innermost loop of the matrix multiplication program, generated
by GCC under maximum optimization (<code class="docutils literal notranslate"><span class="pre">-O3</span></code>). Comments are mine.</p>
<div class="highlight-asm notranslate"><div class="highlight"><pre><span></span><span class="nl">.L4:</span><span class="w">                             </span><span class="c1">; Assembly label to branch to</span>
<span class="w">      </span><span class="nf">movsd</span><span class="w">    </span><span class="p">(</span><span class="nv">%rax</span><span class="p">),</span><span class="w"> </span><span class="nv">%xmm0</span><span class="w">     </span><span class="c1">; Read an element of b into register xmm0</span>
<span class="w">      </span><span class="nf">mulsd</span><span class="w">    </span><span class="p">(</span><span class="nv">%rdx</span><span class="p">),</span><span class="w"> </span><span class="nv">%xmm0</span><span class="w">     </span><span class="c1">; Multiply xmm0 with the element from c</span>
<span class="w">      </span><span class="nf">addq</span><span class="w">     </span><span class="no">$8</span><span class="p">,</span><span class="w"> </span><span class="nv">%rax</span><span class="w">          </span><span class="c1">; Next element of b (a double is 8 bytes)</span>
<span class="w">      </span><span class="nf">addq</span><span class="w">     </span><span class="nv">%rcx</span><span class="p">,</span><span class="w"> </span><span class="nv">%rdx</span><span class="w">        </span><span class="c1">; Next element of c</span>
<span class="w">      </span><span class="nf">addsd</span><span class="w">    </span><span class="nv">%xmm0</span><span class="p">,</span><span class="w"> </span><span class="nv">%xmm1</span><span class="w">      </span><span class="c1">; Add product to partial sum in xmm1</span>
<span class="w">      </span><span class="nf">cmpq</span><span class="w">     </span><span class="nv">%rax</span><span class="p">,</span><span class="w"> </span><span class="nv">%rsi</span><span class="w">        </span><span class="c1">; Have we reached the end of the row of b?</span>
<span class="w">      </span><span class="nf">jne</span><span class="w">      </span><span class="no">.L4</span><span class="w">               </span><span class="c1">; Loop closing branch</span>
</pre></div>
</div>
<p>This is good code; we have nothing to complain about. The compiler has not
generated any <code class="docutils literal notranslate"><span class="pre">fma</span></code> instruction, probably since we have not told it that
it is available.</p>
<p>Recall that register operands are indicated with <code class="docutils literal notranslate"><span class="pre">%</span></code> and immediates
with <code class="docutils literal notranslate"><span class="pre">$</span></code>. Parentheses around a register indicate a memory reference to
the address in the register (register indirect addressing).</p>
<p>We now run <code class="docutils literal notranslate"><span class="pre">perf</span> <span class="pre">stat</span></code> with a small matrix size and enough repetitions to
get a reasonable run time.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>perf<span class="w"> </span>stat<span class="w"> </span>./mmO<span class="w"> </span><span class="m">100</span><span class="w"> </span><span class="m">150</span>
<span class="nv">Ok</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span>

Performance<span class="w"> </span>counter<span class="w"> </span>stats<span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="s1">&#39;./mmO 100 150&#39;</span>:

<span class="w">       </span><span class="m">326</span>,34<span class="w"> </span>msec<span class="w"> </span>task-clock<span class="w">                </span><span class="c1">#    0,999 CPUs utilized</span>
<span class="w">            </span><span class="m">1</span><span class="w">      </span>context-switches<span class="w">          </span><span class="c1">#    0,003 K/sec</span>
<span class="w">            </span><span class="m">0</span><span class="w">      </span>cpu-migrations<span class="w">            </span><span class="c1">#    0,000 K/sec</span>
<span class="w">          </span><span class="m">200</span><span class="w">      </span>page-faults<span class="w">               </span><span class="c1">#    0,613 K/sec</span>
<span class="m">1</span><span class="w"> </span><span class="m">186</span><span class="w"> </span><span class="m">216</span><span class="w"> </span><span class="m">578</span><span class="w">      </span>cycles<span class="w">                    </span><span class="c1">#    3,635 GHz</span>
<span class="m">2</span><span class="w"> </span><span class="m">389</span><span class="w"> </span><span class="m">839</span><span class="w"> </span><span class="m">498</span><span class="w">      </span>instructions<span class="w">              </span><span class="c1">#    2,01  insn per cycle</span>
<span class="w">  </span><span class="m">342</span><span class="w"> </span><span class="m">460</span><span class="w"> </span><span class="m">826</span><span class="w">      </span>branches<span class="w">                  </span><span class="c1"># 1049,404 M/sec</span>
<span class="w">    </span><span class="m">2</span><span class="w"> </span><span class="m">276</span><span class="w"> </span><span class="m">417</span><span class="w">      </span>branch-misses<span class="w">             </span><span class="c1">#    0,66% of all branches</span>

<span class="w"> </span><span class="m">0</span>,326737273<span class="w"> </span>seconds<span class="w"> </span><span class="nb">time</span><span class="w"> </span>elapsed

<span class="w"> </span><span class="m">0</span>,322730000<span class="w"> </span>seconds<span class="w"> </span>user
<span class="w"> </span><span class="m">0</span>,003984000<span class="w"> </span>seconds<span class="w"> </span>sys
</pre></div>
</div>
</div></blockquote>
<p>We can combine the information in these two experiments. The number of iterations
of the innermost loop that we execute is <span class="math notranslate nohighlight">\(100 \times 150^3 = 337500k\)</span> which
we can multiply by the 7 instructions we have in that loop and compare to the
number of instructions executed to verify that we spend 99% of all instructions
within that loop.</p>
<p>We can also see that we execute on average two instructions per cycle, which
tallies with about 3.5 cycles per <code class="docutils literal notranslate"><span class="pre">fma</span></code> we measured previously.</p>
<p>This is surprising. According to Agner Fog’s
<a class="reference external" href="https://www.agner.org/optimize/instruction_tables.pdf">tables</a> (and Intel’s
documentation), the <code class="docutils literal notranslate"><span class="pre">addsd</span></code> instruction has a latency of 4 cycles. The
explanation is that while the instruction window is not large enough to cover
the 150 iterations of the summation loop, it does cover about 28 iterations
so the processor can in fact execute the last iterations of one loop together
with the first iterations of the next. This is also consistent with the
increase in cycles per <code class="docutils literal notranslate"><span class="pre">fma</span></code> as the matrix size increases; the 28 overlapped
iterations become a smaller and smaller part of the whole trip count of the
summation loop.</p>
<figure class="align-default" id="id2">
<img alt="../_images/Inswin.png" src="../_images/Inswin.png" />
<figcaption>
<p><span class="caption-text">The instruction window in the middle of an iteration of the <code class="docutils literal notranslate"><span class="pre">j</span></code> loop.
Several iterations of the <code class="docutils literal notranslate"><span class="pre">k</span></code> loop are visible.</span><a class="headerlink" href="#id2" title="Permalink to this image"></a></p>
</figcaption>
</figure>
<figure class="align-default" id="id3">
<img alt="../_images/Inswin-later.png" src="../_images/Inswin-later.png" />
<figcaption>
<p><span class="caption-text">The instruction window at the boundary between two iterations of the <code class="docutils literal notranslate"><span class="pre">j</span></code>
loop. Parallelism between the iterations is possible.</span><a class="headerlink" href="#id3" title="Permalink to this image"></a></p>
</figcaption>
</figure>
</div>
</section>
<section id="daxpy">
<h2>DAXPY<a class="headerlink" href="#daxpy" title="Permalink to this heading"></a></h2>
<p>At this point, we can conclude that with this program structure, where the
innermost loop computes the sum, we will not get below four cycles per iteration
of that loop for large matrix sizes. This leaves two possibilities:</p>
<ol class="arabic simple">
<li><p>Change the nesting of the loops so that for instance the <code class="docutils literal notranslate"><span class="pre">j</span></code> loop becomes
the innermost. Then there vill not be data dependencies between the iterations
of the innemost loop, enabling more parallelism.</p></li>
<li><p>Do the sums for several elements of the result matrix <code class="docutils literal notranslate"><span class="pre">a</span></code> at the same time.
This also increases parallelism, but this time <em>within</em> each iteration of
the innermost loop.</p></li>
</ol>
<p>We will try alternative 1 first. The inner loop of this version is that of the
the venerable DAXPY routine, which is why we will refer to this version as the
DAXPY version. This loop ordering was used by the vector computers
of old as a building block for matrix multiplication precisely because the loop
iterations are independent.</p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-1-1-0" aria-selected="true" class="sphinx-tabs-tab" id="tab-1-1-0" name="1-0" role="tab" tabindex="0">C</button><button aria-controls="panel-1-1-1" aria-selected="false" class="sphinx-tabs-tab" id="tab-1-1-1" name="1-1" role="tab" tabindex="-1">Fortran</button></div><div aria-labelledby="tab-1-1-0" class="sphinx-tabs-panel" id="panel-1-1-0" name="1-0" role="tabpanel" tabindex="0"><div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="kt">void</span><span class="w"> </span><span class="nf">matmul</span><span class="p">(</span><span class="kt">double</span><span class="o">*</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="kt">double</span><span class="o">*</span><span class="w"> </span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="kt">double</span><span class="o">*</span><span class="w"> </span><span class="n">c</span><span class="p">,</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos"> 2</span><span class="w">  </span><span class="k">for</span><span class="p">(</span><span class="kt">long</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">n</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos"> 3</span><span class="w">    </span><span class="k">for</span><span class="p">(</span><span class="kt">long</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">n</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="n">n</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">j</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos"> 4</span><span class="w">    </span><span class="k">for</span><span class="p">(</span><span class="kt">long</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">n</span><span class="p">;</span><span class="w"> </span><span class="n">k</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos"> 5</span><span class="w">      </span><span class="k">for</span><span class="p">(</span><span class="kt">long</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">n</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos"> 6</span><span class="w">        </span><span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="n">n</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">j</span><span class="p">]</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">b</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="n">n</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">k</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">c</span><span class="p">[</span><span class="n">k</span><span class="o">*</span><span class="n">n</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">j</span><span class="p">];</span>
<span class="linenos"> 7</span><span class="w">      </span><span class="p">}</span>
<span class="linenos"> 8</span><span class="w">    </span><span class="p">}</span>
<span class="linenos"> 9</span><span class="w">  </span><span class="p">}</span>
<span class="linenos">10</span><span class="p">}</span>
</pre></div>
</div>
</div><div aria-labelledby="tab-1-1-1" class="sphinx-tabs-panel" hidden="true" id="panel-1-1-1" name="1-1" role="tabpanel" tabindex="0"><div class="highlight-fortran notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="k">module </span><span class="n">matmul_module</span>
<span class="linenos"> 2</span><span class="w">  </span><span class="k">use </span><span class="n">rtvl_module</span>
<span class="linenos"> 3</span><span class="w">  </span><span class="k">implicit none</span>
<span class="linenos"> 4</span><span class="k">contains</span>
<span class="linenos"> 5</span><span class="k">  subroutine </span><span class="nb">matmul</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="n">c</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">)</span>
<span class="linenos"> 6</span><span class="w">    </span><span class="kt">integer</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">n</span>
<span class="linenos"> 7</span><span class="w">    </span><span class="kt">double precision</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">a</span><span class="p">(</span><span class="n">rtvl</span><span class="p">(</span><span class="n">n</span><span class="p">),</span><span class="n">n</span><span class="p">)</span>
<span class="linenos"> 8</span><span class="w">    </span><span class="kt">double precision</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">b</span><span class="p">(</span><span class="n">rtvl</span><span class="p">(</span><span class="n">n</span><span class="p">),</span><span class="n">n</span><span class="p">),</span><span class="w"> </span><span class="n">c</span><span class="p">(</span><span class="n">rtvl</span><span class="p">(</span><span class="n">n</span><span class="p">),</span><span class="n">n</span><span class="p">)</span>
<span class="linenos"> 9</span><span class="w">    </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">k</span>
<span class="linenos">10</span>
<span class="linenos">11</span><span class="w">    </span><span class="k">do </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">n</span>
<span class="linenos">12</span><span class="w">      </span><span class="n">a</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n</span><span class="p">,</span><span class="n">j</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>
<span class="linenos">13</span><span class="w">      </span><span class="k">do </span><span class="n">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">n</span>
<span class="linenos">14</span><span class="w">        </span><span class="k">do </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">n</span>
<span class="linenos">15</span><span class="w">          </span><span class="n">a</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">a</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">b</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">c</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">j</span><span class="p">)</span>
<span class="linenos">16</span><span class="w">        </span><span class="k">end do</span>
<span class="linenos">17</span><span class="k">      end do</span>
<span class="linenos">18</span><span class="k">    end do</span>
<span class="linenos">19</span><span class="k">  end subroutine </span><span class="nb">matmul</span>
<span class="linenos">20</span><span class="k">end module </span><span class="n">matmul_module</span>
</pre></div>
</div>
</div></div>
<p>As we can see, the reference to <code class="docutils literal notranslate"><span class="pre">b</span></code> is invariant with respect to the innermost
(<code class="docutils literal notranslate"><span class="pre">j</span></code>) loop while the references to the two other matrices are stride 1. That is
because <code class="docutils literal notranslate"><span class="pre">j</span></code> occurs in the index expressions, but only with coefficient 1.</p>
<p>You can build this code as follows:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>gcc<span class="w"> </span>-O<span class="w"> </span>-o<span class="w"> </span>mmD<span class="w"> </span>ex-mm-daxpy.c<span class="w"> </span>ex-mm-main.c<span class="w"> </span>-lm
</pre></div>
</div>
<div class="admonition-exercise exercise important admonition" id="exercise-5">
<p class="admonition-title">Exercise</p>
<p>Explore the performance of the DAXPY variant!</p>
</div>
<div class="admonition-solution solution important dropdown admonition" id="solution-5">
<p class="admonition-title">Solution</p>
<p>On the Core i7-8550U I get the following graph where the baseline is the
previous version under the <code class="docutils literal notranslate"><span class="pre">-O</span></code> omptimization level:</p>
<img alt="../_images/mm2-cpi.png" class="align-center" src="../_images/mm2-cpi.png" />
<p>As we see, the DAXPY version is indeed faster, clocking in at just above
two cycles per iteration of the innermost loop.</p>
</div>
<p>It is instructive to take a look at the assembly code of this version, just to
check what it looks like.</p>
<div class="admonition-exercise exercise important admonition" id="exercise-6">
<p class="admonition-title">Exercise</p>
<p>Check the assembly code generated from the DAXPY version! You get it by
the following command:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>gcc<span class="w"> </span>-O<span class="w"> </span>-o<span class="w"> </span>mmD.s<span class="w"> </span>-S<span class="w"> </span>ex-mm-daxpy.c
</pre></div>
</div>
<p>The resulting code should be about a hundred lines and you should find the
innermost loop where you have multiplication and addition operations (or
an <code class="docutils literal notranslate"><span class="pre">fma</span></code>) with an <code class="docutils literal notranslate"><span class="pre">xmm</span></code> or <code class="docutils literal notranslate"><span class="pre">ymm</span></code> register as operand (if you are
using an x86 machine; if you’re on an ARM the registers will be <code class="docutils literal notranslate"><span class="pre">d0</span></code>, <code class="docutils literal notranslate"><span class="pre">d1</span></code>
and so on).</p>
</div>
<div class="admonition-solution solution important dropdown admonition" id="solution-6">
<p class="admonition-title">Solution</p>
<blockquote>
<div><p>The following is the code I get on GCC version 9.4.0 (yes, I run an ancient
Ubuntu):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="linenos">  1</span>	.file	&quot;ex-mm-daxpy.c&quot;
<span class="linenos">  2</span>	.text
<span class="linenos">  3</span>	.globl	matmul
<span class="linenos">  4</span>	.type	matmul, @function
<span class="linenos">  5</span>matmul:
<span class="linenos">  6</span>.LFB0:
<span class="linenos">  7</span>	.cfi_startproc
<span class="linenos">  8</span>	endbr64
<span class="linenos">  9</span>	testq	%rcx, %rcx
<span class="linenos"> 10</span>	jle	.L11
<span class="linenos"> 11</span>	pushq	%r13
<span class="linenos"> 12</span>	.cfi_def_cfa_offset 16
<span class="linenos"> 13</span>	.cfi_offset 13, -16
<span class="linenos"> 14</span>	pushq	%r12
<span class="linenos"> 15</span>	.cfi_def_cfa_offset 24
<span class="linenos"> 16</span>	.cfi_offset 12, -24
<span class="linenos"> 17</span>	pushq	%rbp
<span class="linenos"> 18</span>	.cfi_def_cfa_offset 32
<span class="linenos"> 19</span>	.cfi_offset 6, -32
<span class="linenos"> 20</span>	pushq	%rbx
<span class="linenos"> 21</span>	.cfi_def_cfa_offset 40
<span class="linenos"> 22</span>	.cfi_offset 3, -40
<span class="linenos"> 23</span>	movq	%rsi, %r8
<span class="linenos"> 24</span>	movq	%rdx, %r10
<span class="linenos"> 25</span>	movq	%rcx, %r12
<span class="linenos"> 26</span>	movq	%rcx, %r11
<span class="linenos"> 27</span>	leaq	0(,%rcx,8), %rbx
<span class="linenos"> 28</span>	addq	%rbx, %r8
<span class="linenos"> 29</span>	movq	%rdi, %r9
<span class="linenos"> 30</span>	leaq	(%rdi,%rbx), %rsi
<span class="linenos"> 31</span>	movq	%rcx, %r13
<span class="linenos"> 32</span>	negq	%r13
<span class="linenos"> 33</span>	salq	$3, %r13
<span class="linenos"> 34</span>	movl	$0, %ebp
<span class="linenos"> 35</span>	jmp	.L3
<span class="linenos"> 36</span>.L14:
<span class="linenos"> 37</span>	addq	$8, %rcx
<span class="linenos"> 38</span>	addq	%r11, %rdi
<span class="linenos"> 39</span>	cmpq	%r8, %rcx
<span class="linenos"> 40</span>	je	.L7
<span class="linenos"> 41</span>.L5:
<span class="linenos"> 42</span>	leaq	(%r10,%rdi,8), %rdx
<span class="linenos"> 43</span>	movq	%r9, %rax
<span class="linenos"> 44</span>.L6:
<span class="linenos"> 45</span>	movsd	(%rcx), %xmm0
<span class="linenos"> 46</span>	mulsd	(%rdx), %xmm0
<span class="linenos"> 47</span>	addsd	(%rax), %xmm0
<span class="linenos"> 48</span>	movsd	%xmm0, (%rax)
<span class="linenos"> 49</span>	addq	$8, %rax
<span class="linenos"> 50</span>	addq	$8, %rdx
<span class="linenos"> 51</span>	cmpq	%rsi, %rax
<span class="linenos"> 52</span>	jne	.L6
<span class="linenos"> 53</span>	jmp	.L14
<span class="linenos"> 54</span>.L7:
<span class="linenos"> 55</span>	addq	$1, %rbp
<span class="linenos"> 56</span>	addq	%rbx, %r8
<span class="linenos"> 57</span>	addq	%rbx, %r9
<span class="linenos"> 58</span>	addq	%rbx, %rsi
<span class="linenos"> 59</span>	cmpq	%rbp, %r12
<span class="linenos"> 60</span>	je	.L1
<span class="linenos"> 61</span>.L3:
<span class="linenos"> 62</span>	movq	%r9, %rax
<span class="linenos"> 63</span>.L4:
<span class="linenos"> 64</span>	movq	$0x000000000, (%rax)
<span class="linenos"> 65</span>	addq	$8, %rax
<span class="linenos"> 66</span>	cmpq	%rsi, %rax
<span class="linenos"> 67</span>	jne	.L4
<span class="linenos"> 68</span>	leaq	(%r8,%r13), %rcx
<span class="linenos"> 69</span>	movl	$0, %edi
<span class="linenos"> 70</span>	jmp	.L5
<span class="linenos"> 71</span>.L1:
<span class="linenos"> 72</span>	popq	%rbx
<span class="linenos"> 73</span>	.cfi_def_cfa_offset 32
<span class="linenos"> 74</span>	popq	%rbp
<span class="linenos"> 75</span>	.cfi_def_cfa_offset 24
<span class="linenos"> 76</span>	popq	%r12
<span class="linenos"> 77</span>	.cfi_def_cfa_offset 16
<span class="linenos"> 78</span>	popq	%r13
<span class="linenos"> 79</span>	.cfi_def_cfa_offset 8
<span class="linenos"> 80</span>	ret
<span class="linenos"> 81</span>.L11:
<span class="linenos"> 82</span>	.cfi_restore 3
<span class="linenos"> 83</span>	.cfi_restore 6
<span class="linenos"> 84</span>	.cfi_restore 12
<span class="linenos"> 85</span>	.cfi_restore 13
<span class="linenos"> 86</span>	ret
<span class="linenos"> 87</span>	.cfi_endproc
<span class="linenos"> 88</span>.LFE0:
<span class="linenos"> 89</span>	.size	matmul, .-matmul
<span class="linenos"> 90</span>	.ident	&quot;GCC: (Ubuntu 9.4.0-1ubuntu1~20.04.2) 9.4.0&quot;
<span class="linenos"> 91</span>	.section	.note.GNU-stack,&quot;&quot;,@progbits
<span class="linenos"> 92</span>	.section	.note.gnu.property,&quot;a&quot;
<span class="linenos"> 93</span>	.align 8
<span class="linenos"> 94</span>	.long	 1f - 0f
<span class="linenos"> 95</span>	.long	 4f - 1f
<span class="linenos"> 96</span>	.long	 5
<span class="linenos"> 97</span>0:
<span class="linenos"> 98</span>	.string	 &quot;GNU&quot;
<span class="linenos"> 99</span>1:
<span class="linenos">100</span>	.align 8
<span class="linenos">101</span>	.long	 0xc0000002
<span class="linenos">102</span>	.long	 3f - 2f
<span class="linenos">103</span>2:
<span class="linenos">104</span>	.long	 0x3
<span class="linenos">105</span>3:
<span class="linenos">106</span>	.align 8
<span class="linenos">107</span>4:
</pre></div>
</div>
</div></blockquote>
<p>The innermost loop is on line 44-52. Here is what it looks like if we
annotate it:</p>
<div class="highlight-asm notranslate"><div class="highlight"><pre><span></span><span class="nl">.L6:</span>
<span class="w">        </span><span class="nf">movsd</span><span class="w">    </span><span class="p">(</span><span class="nv">%rcx</span><span class="p">),</span><span class="w"> </span><span class="nv">%xmm0</span><span class="w">         </span><span class="c1">; Read element of b</span>
<span class="w">        </span><span class="nf">mulsd</span><span class="w">    </span><span class="p">(</span><span class="nv">%rdx</span><span class="p">),</span><span class="w"> </span><span class="nv">%xmm0</span><span class="w">         </span><span class="c1">; Multiply with element of c</span>
<span class="w">        </span><span class="nf">addsd</span><span class="w">    </span><span class="p">(</span><span class="nv">%rax</span><span class="p">),</span><span class="w"> </span><span class="nv">%xmm0</span><span class="w">         </span><span class="c1">; Add to old value in a</span>
<span class="w">        </span><span class="nf">movsd</span><span class="w">    </span><span class="nv">%xmm0</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="nv">%rax</span><span class="p">)</span><span class="w">         </span><span class="c1">; Write back to a</span>
<span class="w">        </span><span class="nf">addq</span><span class="w">     </span><span class="no">$8</span><span class="p">,</span><span class="w"> </span><span class="nv">%rax</span><span class="w">              </span><span class="c1">; Update pointer to a</span>
<span class="w">        </span><span class="nf">addq</span><span class="w">     </span><span class="no">$8</span><span class="p">,</span><span class="w"> </span><span class="nv">%rdx</span><span class="w">              </span><span class="c1">; Update pointer to c</span>
<span class="w">        </span><span class="nf">cmpq</span><span class="w">     </span><span class="nv">%rsi</span><span class="p">,</span><span class="w"> </span><span class="nv">%rax</span><span class="w">            </span><span class="c1">; At endo of row in a?</span>
<span class="w">        </span><span class="nf">jne</span><span class="w">      </span><span class="no">.L6</span><span class="w">                   </span><span class="c1">; Branch back if not</span>
</pre></div>
</div>
<p>There is one thing that stands out here: The reference to <code class="docutils literal notranslate"><span class="pre">b</span></code>, which is
invariant with respect to the innermost (<code class="docutils literal notranslate"><span class="pre">j</span></code>) loop, is not register allocated.
The reason is that the compiler cannot prove that the array <code class="docutils literal notranslate"><span class="pre">b</span></code> does not
overlap with <code class="docutils literal notranslate"><span class="pre">a</span></code> (or more precisely, that the update to <code class="docutils literal notranslate"><span class="pre">a[i*n</span> <span class="pre">+</span> <span class="pre">j]</span></code> never
touches the same memory as <code class="docutils literal notranslate"><span class="pre">b[i*n</span> <span class="pre">+</span> <span class="pre">k]</span></code>. However, doing the register
allocation makes no difference since the load always hits in the cache and
the processor has sufficient memory bandwidth.</p>
<p>A somewhat surprising observation is that the code is not appreciably slowed
down by cache misses. The processor has hardware prefetchers that try to
ensure that data is available in the caches when needed. Since both <code class="docutils literal notranslate"><span class="pre">a</span></code> and
<code class="docutils literal notranslate"><span class="pre">c</span></code> are accessed with stride 1, it is easy for the prefetchers to follow
the pattern. The same row of <code class="docutils literal notranslate"><span class="pre">a</span></code> is reused on every iteration of the (middle)
<code class="docutils literal notranslate"><span class="pre">k</span></code> loop so it will fit in the L1 data cache up to a row length of 4096
when it will fill the cache completely. The <code class="docutils literal notranslate"><span class="pre">c</span></code> matrix will only fit in
L1 for sizes up to 64 by 64, so it will be read from the L2 cache (size up to
160 by 160 or so) or the L3 (up to 1024 by 1024) or memory. Given that we
read eight bytes (a <code class="docutils literal notranslate"><span class="pre">double</span></code>) every two cycles, we’re well within the
bandwidth from the L2 or L3 caches so the prefetcher can keep well ahead.</p>
</div>
<p>The performance limitation for this version is the number of instructions or
uops (<em>work</em>) rather than latency (<em>span</em>) as for the baseline implementation.
There is also no major cache effects as long as at least the <code class="docutils literal notranslate"><span class="pre">c</span></code> matrix fits
in the L3 cache.</p>
<p>Hence, we need to get more work done per instruction. There are several ways in
which this area can be improved.</p>
<ul class="simple">
<li><p>Only scalar arithmetic gets generated; no vector operations.</p></li>
<li><p>No <code class="docutils literal notranslate"><span class="pre">fma</span></code> instructions are used, doubling the number of arithmetic instructions.</p></li>
<li><p>Only a quarter (two out of eight) of the instructions are arithmetic while
the processor supports up to half.</p></li>
</ul>
<section id="vectorization">
<h3>Vectorization<a class="headerlink" href="#vectorization" title="Permalink to this heading"></a></h3>
<p>We will start by addressing the first point. There are in general several ways
to get vectorized code:</p>
<ul class="simple">
<li><p>The easiest is if the compiler can take scalar code and convert it to vectorized
code with no change in the source. This is called <em>autovectorization</em> and it has
been with us for fifty years and at least somewhat useful since forty years or so.
Nowadays, compilers like GCC, Clang and Intel’s icc often do a reasonable job.</p></li>
<li><p>Special <em>intrinsic</em> functions, typically built into the compiler, can be used.
There is typically one intrinsic for each SIMD instruction. These intrinsics
are therefore machine dependent.</p></li>
<li><p>GCC and Clang provide a way to define vector types like “vector of four doubles”
that automatically inherits many operators. Hence, if <code class="docutils literal notranslate"><span class="pre">x</span></code> and <code class="docutils literal notranslate"><span class="pre">y</span></code> are vectors
of the same size and element type, <code class="docutils literal notranslate"><span class="pre">x</span> <span class="pre">+</span> <span class="pre">y</span></code> is their element-wise sum.</p></li>
</ul>
<div class="admonition-exercise exercise important admonition" id="exercise-7">
<p class="admonition-title">Exercise</p>
<p>Let’s try autovectorization! On the version of GCC that I have, auto
vectorization is included in <code class="docutils literal notranslate"><span class="pre">-O3</span></code> optimization, so we recompile our
code thus:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>gcc<span class="w"> </span>-O3<span class="w"> </span>-o<span class="w"> </span>mmD<span class="w"> </span>ex-mm-daxpy.c<span class="w"> </span>ex-mm-main.c<span class="w"> </span>-lm
</pre></div>
</div>
<p>Do we get any performance difference?</p>
</div>
<div class="admonition-solution solution important dropdown admonition" id="solution-7">
<p class="admonition-title">Solution</p>
<p>On the Core i7-8550U we get the following:</p>
<img alt="../_images/mm2opt-cpi.png" class="align-center" src="../_images/mm2opt-cpi.png" />
<p>We can see that we get almost another factor of two.</p>
</div>
<div class="admonition-example admonition">
<p class="admonition-title">Example</p>
<p>The effect of <code class="docutils literal notranslate"><span class="pre">-O3</span></code> on the Core i7-8550U. The assembly code of the
innermost loop now looks as follows:</p>
<div class="highlight-asm notranslate"><div class="highlight"><pre><span></span><span class="nl">.L7:</span>
<span class="w">        </span><span class="nf">movupd</span><span class="w">   </span><span class="p">(</span><span class="nv">%rax</span><span class="p">,</span><span class="nv">%r9</span><span class="p">),</span><span class="w"> </span><span class="nv">%xmm0</span><span class="w">     </span><span class="c1">; Read elements of c</span>
<span class="w">        </span><span class="nf">movupd</span><span class="w">   </span><span class="p">(</span><span class="nv">%rcx</span><span class="p">,</span><span class="nv">%r9</span><span class="p">),</span><span class="w"> </span><span class="nv">%xmm2</span><span class="w">     </span><span class="c1">; Read elements of a</span>
<span class="w">        </span><span class="nf">mulpd</span><span class="w">    </span><span class="nv">%xmm1</span><span class="p">,</span><span class="w"> </span><span class="nv">%xmm0</span><span class="w">          </span><span class="c1">; Multiply elements from b and c</span>
<span class="w">        </span><span class="nf">addpd</span><span class="w">    </span><span class="nv">%xmm2</span><span class="p">,</span><span class="w"> </span><span class="nv">%xmm0</span><span class="w">          </span><span class="c1">; Add to elements of a</span>
<span class="w">        </span><span class="nf">movups</span><span class="w">   </span><span class="nv">%xmm0</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="nv">%rcx</span><span class="p">,</span><span class="nv">%r9</span><span class="p">)</span><span class="w">     </span><span class="c1">; Write sum to a</span>
<span class="w">        </span><span class="nf">addq</span><span class="w">     </span><span class="no">$16</span><span class="p">,</span><span class="w"> </span><span class="nv">%r9</span><span class="w">              </span><span class="c1">; Update offsets</span>
<span class="w">        </span><span class="nf">cmpq</span><span class="w">     </span><span class="nv">%r9</span><span class="p">,</span><span class="w"> </span><span class="nv">%rbp</span><span class="w">             </span><span class="c1">; Done?</span>
<span class="w">        </span><span class="nf">jne</span><span class="w">      </span><span class="no">.L7</span><span class="w">                   </span><span class="c1">; Branch back if not</span>
</pre></div>
</div>
<p>This code uses addresses of the form <code class="docutils literal notranslate"><span class="pre">(%rax,%r9)</span></code> which refer to the memory
location whose address is the sum of the contents of the two registers. So
<code class="docutils literal notranslate"><span class="pre">rax</span></code> holds the address of the current row in
<code class="docutils literal notranslate"><span class="pre">c</span></code> while <code class="docutils literal notranslate"><span class="pre">rcx</span></code> points at the start of the current row in
<code class="docutils literal notranslate"><span class="pre">a</span></code>.</p>
<p>The use of <code class="docutils literal notranslate"><span class="pre">xmm</span></code> registers as well as the add of 16 to the offset in
<code class="docutils literal notranslate"><span class="pre">r9</span></code> indicate that the compiler has chosen a SIMD vector length of 128 bits,
or two <code class="docutils literal notranslate"><span class="pre">double</span></code> values. Hence each iteration of the innermost loop now
computes two <code class="docutils literal notranslate"><span class="pre">fma</span></code> operations so the slightly above 1.2 cycles per
<code class="docutils literal notranslate"><span class="pre">fma</span></code> results indicate an inner loop time of just under 2.5 cycles on average.</p>
</div>
<p>Given the number of variants of the x86 architecture, what code should be
generated by a compiler like GCC? If GCC generates code very conservatively,
using only instructions that are included in all processors that have been
produced for many years, the code will run on just about any x86 machine out there.
However, it will not take advantage of more recent improvements like SIMD
vector extensions.</p>
<p>The most common compromise struck by GCC on 64-bit systems (almost all today) is
to go for the first 64-bit version of the x86 architecture, often referred to
as x86_64. This includes 128-bit SIMD vector support, but not the 256 bit AVX.
This default is decided when GCC is compiled, so it is up to the distribution,
for instance Ubuntu, to make the choice.</p>
<p>It is always possible to tell GCC to generate code for a particlar instruction set
using the <code class="docutils literal notranslate"><span class="pre">-march</span></code> option. If you want code that uses all of the features of
the machine on which you run the compiler, you can use <code class="docutils literal notranslate"><span class="pre">-march=native</span></code>.</p>
<div class="admonition-example admonition">
<p class="admonition-title">Example</p>
<p>Let us see what code we get if we tell GCC to generate code specifically for the
Core i7-8550U. We do this by compiling the matrix multiplication program
as follows:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>gcc<span class="w"> </span>-O3<span class="w"> </span>-march<span class="o">=</span>native<span class="w"> </span>-S<span class="w"> </span>-o<span class="w"> </span>mmD.s<span class="w"> </span>ex-mm-daxpy.c
</pre></div>
</div>
<p>This gives us the following code for the innermost loop:</p>
<div class="highlight-asm notranslate"><div class="highlight"><pre><span></span><span class="nl">.L7:</span>
<span class="w">        </span><span class="nf">vmovupd</span><span class="w">     </span><span class="p">(</span><span class="nv">%rax</span><span class="p">,</span><span class="nv">%rdi</span><span class="p">),</span><span class="w"> </span><span class="nv">%ymm0</span><span class="w">          </span><span class="c1">; Read elements from c</span>
<span class="w">        </span><span class="nf">vfmadd213pd</span><span class="w"> </span><span class="p">(</span><span class="nv">%rcx</span><span class="p">,</span><span class="nv">%rdi</span><span class="p">),</span><span class="w"> </span><span class="nv">%ymm1</span><span class="p">,</span><span class="w"> </span><span class="nv">%ymm0</span><span class="w">   </span><span class="c1">; fma with element from a</span>
<span class="w">        </span><span class="nf">vmovupd</span><span class="w">     </span><span class="nv">%ymm0</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="nv">%rcx</span><span class="p">,</span><span class="nv">%rdi</span><span class="p">)</span><span class="w">          </span><span class="c1">; Write back to a</span>
<span class="w">        </span><span class="nf">addq</span><span class="w">        </span><span class="no">$32</span><span class="p">,</span><span class="w"> </span><span class="nv">%rdi</span><span class="w">                   </span><span class="c1">; Increment offset</span>
<span class="w">        </span><span class="nf">cmpq</span><span class="w">        </span><span class="nv">%rdi</span><span class="p">,</span><span class="w"> </span><span class="nv">%rbx</span><span class="w">                  </span><span class="c1">; Done?</span>
<span class="w">        </span><span class="nf">jne</span><span class="w">         </span><span class="no">.L7</span><span class="w">                         </span><span class="c1">; Branch back if not</span>
</pre></div>
</div>
<p>This is excellent code:</p>
<ul>
<li><p>Finally, we actually get the fma instruction. The <code class="docutils literal notranslate"><span class="pre">pd</span></code> at the end
says that it is <em>packed</em> (that is, a vector operation) and that the
element type is <em>double</em>. The <code class="docutils literal notranslate"><span class="pre">213</span></code> controls the interpretation of
the operands; in this case we have approximately:</p>
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="n">ymm0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">memory</span><span class="p">[</span><span class="n">rcx</span><span class="o">+</span><span class="n">rdi</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">ymm0</span><span class="o">*</span><span class="n">ymm1</span>
</pre></div>
</div>
</li>
<li><p>Both the use of the 256 bit <code class="docutils literal notranslate"><span class="pre">ymm</span></code> registers and the value 32 being
added to the offset in <code class="docutils literal notranslate"><span class="pre">rdi</span></code> tells us that we now get 256-bit code.</p></li>
</ul>
</div>
<div class="admonition-exercise exercise important admonition" id="exercise-8">
<p class="admonition-title">Exercise</p>
<p>Explore the performance effect of compiling for your native machine!
Compile with</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>gcc<span class="w"> </span>-O3<span class="w"> </span>-march<span class="o">=</span>native<span class="w"> </span>-o<span class="w"> </span>mmD<span class="w"> </span>ex-mm-daxpy.c<span class="w"> </span>ex-mm-main.c<span class="w"> </span>-lm
</pre></div>
</div>
<p>Do we get any performance difference?</p>
</div>
<div class="admonition-solution solution important dropdown admonition" id="solution-8">
<p class="admonition-title">Solution</p>
<p>On the Core i7-8550U, we get the following:</p>
<img alt="../_images/mm2native-cpi.png" class="align-center" src="../_images/mm2native-cpi.png" />
<p>There are some interesting things to see in this graph:</p>
<ul class="simple">
<li><p>There is a wavy pattern to the native version with every other point
having better performance.</p></li>
<li><p>The performance has not really doubled, although there is a substantial
improvement.</p></li>
</ul>
</div>
<p>One phenomenon that we now encounter for the first time is the cost of unaligned
data accesses. When the matrix size is divisible by two but not by four (as in
for instance 150), the length of a row is not an integral number of 32 byte
SIMD vectors. Rather, each row is of length “something-and-a-half” vectors. Thus
every other row will not be vector aligned. This will lead to vector accesses
that straddle a cache line boundary, necessitating two tag look-ups with the
attendant increase in access time. Note that this happens not only at the start
of such rows, but for every other iteration of the <code class="docutils literal notranslate"><span class="pre">j</span></code> loop.</p>
<p>One way to handle this problem is to use a padded representation of matrices. Thus,
during the mapping of the two index dimensions to the single linear offset, we
round the row length to the nearest multiple of four (in this case).</p>
<p>This in implemented in this padded version of the code where <code class="docutils literal notranslate"><span class="pre">rtvl()</span></code> (round to
vector length) is a function that rounds its argument to the next multiple of 4:</p>
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;rtvl.h&quot;</span>
<span class="linenos"> 2</span>
<span class="linenos"> 3</span><span class="kt">void</span><span class="w"> </span><span class="nf">matmul</span><span class="p">(</span><span class="kt">double</span><span class="o">*</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="kt">double</span><span class="o">*</span><span class="w"> </span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="kt">double</span><span class="o">*</span><span class="w"> </span><span class="n">c</span><span class="p">,</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos"> 4</span><span class="w">  </span><span class="kt">long</span><span class="w"> </span><span class="n">rn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rtvl</span><span class="p">(</span><span class="n">n</span><span class="p">);</span>
<span class="linenos"> 5</span><span class="w">  </span><span class="k">for</span><span class="p">(</span><span class="kt">long</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">n</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos"> 6</span><span class="w">    </span><span class="k">for</span><span class="p">(</span><span class="kt">long</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">n</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="n">rn</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">j</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="linenos"> 7</span><span class="w">    </span><span class="k">for</span><span class="p">(</span><span class="kt">long</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">n</span><span class="p">;</span><span class="w"> </span><span class="n">k</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos"> 8</span><span class="w">      </span><span class="k">for</span><span class="p">(</span><span class="kt">long</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">n</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos"> 9</span><span class="w">        </span><span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="n">rn</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">j</span><span class="p">]</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">b</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="n">rn</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">k</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">c</span><span class="p">[</span><span class="n">k</span><span class="o">*</span><span class="n">rn</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">j</span><span class="p">];</span>
<span class="linenos">10</span><span class="w">      </span><span class="p">}</span>
<span class="linenos">11</span><span class="w">    </span><span class="p">}</span>
<span class="linenos">12</span><span class="w">  </span><span class="p">}</span>
<span class="linenos">13</span><span class="p">}</span>
</pre></div>
</div>
<p>Note that we only use the rounded size for the index computations, not for the
loop bounds.
For this code to work correctly, the caller must also use the same padding.</p>
<div class="admonition-exercise exercise important admonition" id="exercise-9">
<p class="admonition-title">Exercise</p>
<p>Explore the performance effect of padding!
Compile with</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>gcc<span class="w"> </span>-O3<span class="w"> </span>-march<span class="o">=</span>native<span class="w"> </span>-DRTVL<span class="w"> </span>-o<span class="w"> </span>mmDp<span class="w"> </span>ex-mm-daxpy-p.c<span class="w"> </span>ex-mm-main.c<span class="w"> </span>-lm
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">-DRTVL</span></code> enables the <code class="docutils literal notranslate"><span class="pre">rtvl()</span></code> function which otherwise just returns its
argument. This allows us to use the same <code class="docutils literal notranslate"><span class="pre">ex-mm-main.c</span></code> with both padded and
unpadded matrix multiplication functions.</p>
<p>Do we get any performance difference?</p>
</div>
<div class="admonition-solution solution important dropdown admonition" id="solution-9">
<p class="admonition-title">Solution</p>
<p>On the Core i7-8550U, we get the following:</p>
<img alt="../_images/mm3pad-cpi.png" class="align-center" src="../_images/mm3pad-cpi.png" />
<p>Here we have eliminated some of the less aggressively tuned variants, and, since
we are starting to get somewhere, added the ideal performance curve as a
tantalizing glimpse.</p>
<p>The graph for the new version clearly shows that padding solved the problem.
All of the vector reads are now aligned. We are also starting to see a pattern
that will follow us from now on: we get the highest efficiency for intermediate
matrix sizes. This is since there is certain overhead (clearing <code class="docutils literal notranslate"><span class="pre">a</span></code>, loop
management) that scales as <span class="math notranslate nohighlight">\(n^2\)</span> or better while the work in the innermost
loop scales as <span class="math notranslate nohighlight">\(n^3\)</span>.</p>
<p>On the other hand, all reuse distances increase when the matrix size
grows so we get
worse locality and more cache misses. The effect is noticable but not dramatic;
the L3 bandwidth is
sufficient to feed the execution unit while the hardware prefetch mitigates the
latency problems.</p>
<p>Using <code class="docutils literal notranslate"><span class="pre">perf</span> <span class="pre">stat</span></code> we can see that we have a bit over three instructions per
cycle for size 100 (fits in L2) and around 2.5 for size 200 (fits in L3).</p>
</div>
<p>We are now a factor of four to five above the ideal performance and we execute
at about three instructions per cycle out of the theoretical maximum of four, so
in order to get a substantial improvement, we must execute fewer instructions.</p>
<p>The innermost loop (in the example above) contains one vector <code class="docutils literal notranslate"><span class="pre">fma</span></code> instruction,
two data movements instructions and three housekeeping instructions (pointer update,
loop control). We need to get more arithmetic compared to the rest of the
operations.</p>
<p>There are two potential ways to accomplish this:</p>
<ul class="simple">
<li><p>Loop unrolling would decrease the house keeping fraction.</p></li>
<li><p>Register blocking would increase the compute fraction.</p></li>
</ul>
<p>Out of these two, we will do the register blocking since we can not perform loop
unrolling as a source level transformation as it would interfere with the
autovectorization done by the compiler.</p>
</section>
</section>
<section id="blocking-for-registers">
<h2>Blocking for registers<a class="headerlink" href="#blocking-for-registers" title="Permalink to this heading"></a></h2>
<p>Register blocking looks at the memory references in the innermost loop and attempt to
amortize these over more computation. We get the additional computation by executing
multiple iterations of the enclosing loops at once. Here is the
new version of the code:</p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-2-2-0" aria-selected="true" class="sphinx-tabs-tab" id="tab-2-2-0" name="2-0" role="tab" tabindex="0">C</button><button aria-controls="panel-2-2-1" aria-selected="false" class="sphinx-tabs-tab" id="tab-2-2-1" name="2-1" role="tab" tabindex="-1">Fortran</button></div><div aria-labelledby="tab-2-2-0" class="sphinx-tabs-panel" id="panel-2-2-0" name="2-0" role="tabpanel" tabindex="0"><div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;rtvl.h&quot;</span>
<span class="linenos"> 2</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;string.h&gt;</span>
<span class="linenos"> 3</span>
<span class="linenos"> 4</span><span class="kt">void</span><span class="w"> </span><span class="nf">matmul</span><span class="p">(</span><span class="kt">double</span><span class="o">*</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="kt">double</span><span class="o">*</span><span class="w"> </span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="kt">double</span><span class="o">*</span><span class="w"> </span><span class="n">c</span><span class="p">,</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos"> 5</span><span class="w">  </span><span class="kt">long</span><span class="w"> </span><span class="n">rn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rtvl</span><span class="p">(</span><span class="n">n</span><span class="p">);</span>
<span class="linenos"> 6</span><span class="w">  </span><span class="kt">long</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">n</span><span class="o">%</span><span class="mi">4</span><span class="p">;</span>
<span class="linenos"> 7</span><span class="w">  </span><span class="k">for</span><span class="p">(</span><span class="kt">long</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">n</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">+=</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos"> 8</span><span class="w">    </span><span class="n">memset</span><span class="p">(</span><span class="n">a</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">i</span><span class="o">*</span><span class="n">rn</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="o">*</span><span class="n">rn</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">double</span><span class="p">));</span>
<span class="linenos"> 9</span><span class="w">    </span><span class="k">for</span><span class="p">(</span><span class="kt">long</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">n</span><span class="mi">-3</span><span class="p">;</span><span class="w"> </span><span class="n">k</span><span class="o">+=</span><span class="mi">4</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">10</span><span class="w">      </span><span class="kt">double</span><span class="w"> </span><span class="n">b00</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">b</span><span class="p">[(</span><span class="n">i</span><span class="o">+</span><span class="mi">0</span><span class="p">)</span><span class="o">*</span><span class="n">rn</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">0</span><span class="p">];</span>
<span class="linenos">11</span><span class="w">      </span><span class="kt">double</span><span class="w"> </span><span class="n">b01</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">b</span><span class="p">[(</span><span class="n">i</span><span class="o">+</span><span class="mi">0</span><span class="p">)</span><span class="o">*</span><span class="n">rn</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">];</span>
<span class="linenos">12</span><span class="w">      </span><span class="kt">double</span><span class="w"> </span><span class="n">b02</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">b</span><span class="p">[(</span><span class="n">i</span><span class="o">+</span><span class="mi">0</span><span class="p">)</span><span class="o">*</span><span class="n">rn</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span><span class="p">];</span>
<span class="linenos">13</span><span class="w">      </span><span class="kt">double</span><span class="w"> </span><span class="n">b03</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">b</span><span class="p">[(</span><span class="n">i</span><span class="o">+</span><span class="mi">0</span><span class="p">)</span><span class="o">*</span><span class="n">rn</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">3</span><span class="p">];</span>
<span class="linenos">14</span><span class="w">      </span><span class="kt">double</span><span class="w"> </span><span class="n">b10</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">b</span><span class="p">[(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">rn</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">0</span><span class="p">];</span>
<span class="linenos">15</span><span class="w">      </span><span class="kt">double</span><span class="w"> </span><span class="n">b11</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">b</span><span class="p">[(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">rn</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">];</span>
<span class="linenos">16</span><span class="w">      </span><span class="kt">double</span><span class="w"> </span><span class="n">b12</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">b</span><span class="p">[(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">rn</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span><span class="p">];</span>
<span class="linenos">17</span><span class="w">      </span><span class="kt">double</span><span class="w"> </span><span class="n">b13</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">b</span><span class="p">[(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">rn</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">3</span><span class="p">];</span>
<span class="linenos">18</span><span class="w">      </span><span class="cp">#pragma omp simd</span>
<span class="linenos">19</span><span class="w">      </span><span class="k">for</span><span class="p">(</span><span class="kt">long</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">n</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">20</span><span class="w">        </span><span class="kt">double</span><span class="w"> </span><span class="n">s0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="n">rn</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">j</span><span class="p">];</span>
<span class="linenos">21</span><span class="w">        </span><span class="kt">double</span><span class="w"> </span><span class="n">s1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">a</span><span class="p">[(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">rn</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">j</span><span class="p">];</span>
<span class="linenos">22</span><span class="w">        </span><span class="n">s0</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">b00</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">c</span><span class="p">[</span><span class="n">k</span><span class="o">*</span><span class="n">rn</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">j</span><span class="p">];</span>
<span class="linenos">23</span><span class="w">        </span><span class="n">s1</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">b10</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">c</span><span class="p">[</span><span class="n">k</span><span class="o">*</span><span class="n">rn</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">j</span><span class="p">];</span>
<span class="linenos">24</span><span class="w">        </span><span class="n">s0</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">b01</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">c</span><span class="p">[(</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">rn</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">j</span><span class="p">];</span>
<span class="linenos">25</span><span class="w">        </span><span class="n">s1</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">b11</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">c</span><span class="p">[(</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">rn</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">j</span><span class="p">];</span>
<span class="linenos">26</span><span class="w">        </span><span class="n">s0</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">b02</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">c</span><span class="p">[(</span><span class="n">k</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">rn</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">j</span><span class="p">];</span>
<span class="linenos">27</span><span class="w">        </span><span class="n">s1</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">b12</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">c</span><span class="p">[(</span><span class="n">k</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">rn</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">j</span><span class="p">];</span>
<span class="linenos">28</span><span class="w">        </span><span class="n">s0</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">b03</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">c</span><span class="p">[(</span><span class="n">k</span><span class="o">+</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="n">rn</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">j</span><span class="p">];</span>
<span class="linenos">29</span><span class="w">        </span><span class="n">s1</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">b13</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">c</span><span class="p">[(</span><span class="n">k</span><span class="o">+</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="n">rn</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">j</span><span class="p">];</span>
<span class="linenos">30</span><span class="w">        </span><span class="n">a</span><span class="p">[</span><span class="w">    </span><span class="n">i</span><span class="o">*</span><span class="n">rn</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">j</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">s0</span><span class="p">;</span>
<span class="linenos">31</span><span class="w">        </span><span class="n">a</span><span class="p">[(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">rn</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">j</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">s1</span><span class="p">;</span>
<span class="linenos">32</span><span class="w">      </span><span class="p">}</span>
<span class="linenos">33</span><span class="w">    </span><span class="p">}</span>
<span class="linenos">34</span><span class="w">    </span><span class="k">for</span><span class="p">(</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">n</span><span class="o">-</span><span class="n">m</span><span class="p">;</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">n</span><span class="p">;</span><span class="w"> </span><span class="n">k</span><span class="o">++</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">35</span><span class="w">      </span><span class="cp">#pragma omp simd</span>
<span class="linenos">36</span><span class="w">      </span><span class="k">for</span><span class="p">(</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">n</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="o">++</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">37</span><span class="w">        </span><span class="n">a</span><span class="p">[</span><span class="w">    </span><span class="n">i</span><span class="o">*</span><span class="n">n</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">j</span><span class="p">]</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">b</span><span class="p">[</span><span class="w">    </span><span class="n">i</span><span class="o">*</span><span class="n">n</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">k</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">c</span><span class="p">[</span><span class="n">k</span><span class="o">*</span><span class="n">n</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">j</span><span class="p">];</span>
<span class="linenos">38</span><span class="w">        </span><span class="n">a</span><span class="p">[(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">n</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">j</span><span class="p">]</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">b</span><span class="p">[(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">n</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">k</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">c</span><span class="p">[</span><span class="n">k</span><span class="o">*</span><span class="n">n</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">j</span><span class="p">];</span>
<span class="linenos">39</span><span class="w">      </span><span class="p">}</span>
<span class="linenos">40</span><span class="w">    </span><span class="p">}</span>
<span class="linenos">41</span><span class="w">  </span><span class="p">}</span>
<span class="linenos">42</span><span class="p">}</span>
</pre></div>
</div>
</div><div aria-labelledby="tab-2-2-1" class="sphinx-tabs-panel" hidden="true" id="panel-2-2-1" name="2-1" role="tabpanel" tabindex="0"><div class="highlight-fortran notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="k">module </span><span class="n">matmul_module</span>
<span class="linenos"> 2</span><span class="w">  </span><span class="k">use </span><span class="n">rtvl_module</span>
<span class="linenos"> 3</span><span class="w">  </span><span class="k">implicit none</span>
<span class="linenos"> 4</span><span class="k">contains</span>
<span class="linenos"> 5</span><span class="k">  subroutine </span><span class="nb">matmul</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="n">c</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">)</span>
<span class="linenos"> 6</span><span class="w">    </span><span class="kt">integer</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">n</span>
<span class="linenos"> 7</span><span class="w">    </span><span class="kt">double precision</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">a</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>
<span class="linenos"> 8</span><span class="w">    </span><span class="kt">double precision</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">b</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="n">n</span><span class="p">),</span><span class="w"> </span><span class="n">c</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>
<span class="linenos"> 9</span><span class="w">    </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">,</span><span class="w"> </span><span class="n">rn</span><span class="p">,</span><span class="w"> </span><span class="n">m</span>
<span class="linenos">10</span><span class="w">    </span><span class="kt">double precision</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">c00</span><span class="p">,</span><span class="w"> </span><span class="n">c10</span><span class="p">,</span><span class="w"> </span><span class="n">c20</span><span class="p">,</span><span class="w"> </span><span class="n">c30</span><span class="p">,</span><span class="w"> </span><span class="n">c01</span><span class="p">,</span><span class="w"> </span><span class="n">c11</span><span class="p">,</span><span class="w"> </span><span class="n">c21</span><span class="p">,</span><span class="w"> </span><span class="n">c31</span>
<span class="linenos">11</span><span class="w">    </span><span class="kt">double precision</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">s0</span><span class="p">,</span><span class="w"> </span><span class="n">s1</span>
<span class="linenos">12</span>
<span class="linenos">13</span><span class="w">    </span><span class="n">rn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rtvl</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
<span class="linenos">14</span><span class="w">    </span><span class="n">m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">mod</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">)</span>
<span class="linenos">15</span>
<span class="linenos">16</span><span class="w">    </span><span class="k">do </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span>
<span class="linenos">17</span><span class="w">      </span><span class="n">a</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n</span><span class="p">,</span><span class="n">j</span><span class="p">:</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>
<span class="linenos">18</span><span class="w">      </span><span class="k">do </span><span class="n">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="o">-</span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span>
<span class="linenos">19</span><span class="w">        </span><span class="n">c00</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">c</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="w">  </span><span class="n">j</span><span class="p">)</span>
<span class="linenos">20</span><span class="w">        </span><span class="n">c10</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">c</span><span class="p">(</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">)</span>
<span class="linenos">21</span><span class="w">        </span><span class="n">c20</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">c</span><span class="p">(</span><span class="n">k</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span><span class="n">j</span><span class="p">)</span>
<span class="linenos">22</span><span class="w">        </span><span class="n">c30</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">c</span><span class="p">(</span><span class="n">k</span><span class="o">+</span><span class="mi">3</span><span class="p">,</span><span class="n">j</span><span class="p">)</span>
<span class="linenos">23</span><span class="w">        </span><span class="n">c01</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">c</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="w">  </span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
<span class="linenos">24</span><span class="w">        </span><span class="n">c11</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">c</span><span class="p">(</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
<span class="linenos">25</span><span class="w">        </span><span class="n">c21</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">c</span><span class="p">(</span><span class="n">k</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
<span class="linenos">26</span><span class="w">        </span><span class="n">c31</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">c</span><span class="p">(</span><span class="n">k</span><span class="o">+</span><span class="mi">3</span><span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
<span class="linenos">27</span><span class="w">        </span><span class="k">do </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">n</span>
<span class="linenos">28</span><span class="w">          </span><span class="n">s0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">a</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">)</span>
<span class="linenos">29</span><span class="w">          </span><span class="n">s1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">a</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
<span class="linenos">30</span><span class="w">          </span><span class="n">s0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">s0</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">b</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">k</span><span class="o">+</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">c00</span>
<span class="linenos">31</span><span class="w">          </span><span class="n">s1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">s1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">b</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">k</span><span class="o">+</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">c01</span>
<span class="linenos">32</span><span class="w">          </span><span class="n">s0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">s0</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">b</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">c10</span>
<span class="linenos">33</span><span class="w">          </span><span class="n">s1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">s1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">b</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">c11</span>
<span class="linenos">34</span><span class="w">          </span><span class="n">s0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">s0</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">b</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">k</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">c20</span>
<span class="linenos">35</span><span class="w">          </span><span class="n">s1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">s1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">b</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">k</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">c21</span>
<span class="linenos">36</span><span class="w">          </span><span class="n">s0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">s0</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">b</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">k</span><span class="o">+</span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">c30</span>
<span class="linenos">37</span><span class="w">          </span><span class="n">s1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">s1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">b</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">k</span><span class="o">+</span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">c31</span>
<span class="linenos">38</span><span class="w">          </span><span class="n">a</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">)</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="n">s0</span>
<span class="linenos">39</span><span class="w">          </span><span class="n">a</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">s1</span>
<span class="linenos">40</span><span class="w">        </span><span class="k">end do</span>
<span class="linenos">41</span><span class="k">      end do</span>
<span class="linenos">42</span><span class="k">      do </span><span class="n">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">n</span><span class="o">-</span><span class="n">m</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">n</span>
<span class="linenos">43</span><span class="w">        </span><span class="k">do </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">n</span>
<span class="linenos">44</span><span class="w">          </span><span class="n">a</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">)</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">a</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">)</span><span class="w">   </span><span class="o">+</span><span class="w"> </span><span class="n">b</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">c</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">j</span><span class="p">)</span>
<span class="linenos">45</span><span class="w">          </span><span class="n">a</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">=</span><span class="w"> </span><span class="n">a</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">b</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">c</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
<span class="linenos">46</span><span class="w">        </span><span class="k">end do</span>
<span class="linenos">47</span><span class="k">      end do</span>
<span class="linenos">48</span><span class="k">    end do</span>
<span class="linenos">49</span><span class="k">  end subroutine </span><span class="nb">matmul</span>
<span class="linenos">50</span><span class="k">end module </span><span class="n">matmul_module</span>
</pre></div>
</div>
</div></div>
<p>There is quite a lot to unpack here:</p>
<ul class="simple">
<li><p>Looking at the innermost loop, lines 19-32,
we see eight <code class="docutils literal notranslate"><span class="pre">+=</span></code> operators, working on scalar
variables rather than directly at the <code class="docutils literal notranslate"><span class="pre">a</span></code> matrix. There are two partial sum
variables, <code class="docutils literal notranslate"><span class="pre">s0</span></code> and <code class="docutils literal notranslate"><span class="pre">s1</span></code>, each used four times.</p></li>
<li><p>In the innermost loop, we see that <code class="docutils literal notranslate"><span class="pre">k</span></code>, <code class="docutils literal notranslate"><span class="pre">k+1</span></code>, <code class="docutils literal notranslate"><span class="pre">k+2</span></code>, and <code class="docutils literal notranslate"><span class="pre">k+3</span></code> are
used and the <code class="docutils literal notranslate"><span class="pre">k</span></code> loop (line 9) uses an increment of 4.</p></li>
<li><p>The reads and writes to the <code class="docutils literal notranslate"><span class="pre">a</span></code> matrix use both
<code class="docutils literal notranslate"><span class="pre">i</span></code> and <code class="docutils literal notranslate"><span class="pre">i+1</span></code> in the index expressions, and the
<code class="docutils literal notranslate"><span class="pre">i</span></code> loop (line 7) has an increment of 2.</p></li>
<li><p>Putting the last two observations together, we have blocked with respect to the
<code class="docutils literal notranslate"><span class="pre">i</span></code> and <code class="docutils literal notranslate"><span class="pre">k</span></code> loops with blocking factors of 2 and 4, respectively, which also
tallies with the eight (<span class="math notranslate nohighlight">\(2 \times 4\)</span>) <code class="docutils literal notranslate"><span class="pre">+=</span></code> operators in the innermost loop.</p></li>
<li><p>Tke <code class="docutils literal notranslate"><span class="pre">k</span></code> loop (line 9) only iterates if
<code class="docutils literal notranslate"><span class="pre">k</span> <span class="pre">&lt;</span> <span class="pre">n-3</span></code> in order not to overshoot if
<code class="docutils literal notranslate"><span class="pre">n</span></code> is not a multiple of four. The remaining 0-3 iterations are performed
in lines 34-40.</p></li>
<li><p>There is no corresponding provision for odd values of <code class="docutils literal notranslate"><span class="pre">n</span></code> in the
<code class="docutils literal notranslate"><span class="pre">i</span></code> loop (line 7), so this version of the code only works for even matrix
sizes (including those not a multiple of four).</p></li>
<li><p>There are two OpenMP pragmas (lines 18 and 35). These instruct the compiler
to SIMD-vectorize the code. Unfortunately, the blocked inner loop is too big
for <code class="docutils literal notranslate"><span class="pre">gcc</span></code> to do the SIMD vectorization without this explicit request.</p></li>
</ul>
<p>The strategy behind the block selection (2 in the <code class="docutils literal notranslate"><span class="pre">i</span></code> direction and 4 in
the <code class="docutils literal notranslate"><span class="pre">k</span></code> direction) is that each direction saves work in the memory accesses
that do not depend on that loop variable. There are two accesses to the <code class="docutils literal notranslate"><span class="pre">a</span></code>
matrix (a read and a write) so we bring the number of accesses from two per <code class="docutils literal notranslate"><span class="pre">fma</span></code>
to one half per <code class="docutils literal notranslate"><span class="pre">fma</span></code>.</p>
<p>As for the <code class="docutils literal notranslate"><span class="pre">c[k*rn</span> <span class="pre">+</span> <span class="pre">j]</span></code> access from the non blocked version, it is independent of
<code class="docutils literal notranslate"><span class="pre">i</span></code> so the same matric element will be reused for different values of that variable.
In the original, there is one read per <code class="docutils literal notranslate"><span class="pre">fma</span></code> operation, so the blocking factor of
2 for <code class="docutils literal notranslate"><span class="pre">i</span></code> gives us one half read for each
<code class="docutils literal notranslate"><span class="pre">fma</span></code>. Exchanging the blocking factors would give us one reference to
<code class="docutils literal notranslate"><span class="pre">a</span></code> and a quarter of a reference to
<code class="docutils literal notranslate"><span class="pre">c</span></code> for every compute instruction which is clearly worse.</p>
<p>We can verify this analysis by referring to the innermost loop in lines 19-32 and
counting</p>
<blockquote>
<div><p><code class="docutils literal notranslate"><span class="pre">...</span> <span class="pre">+=</span> <span class="pre">...</span> <span class="pre">*</span> <span class="pre">...</span></code></p>
</div></blockquote>
<p>statements and unique memory references (the
compiler deals with multiple copies of the same expression).</p>
<ul class="simple">
<li><p>Two reads of <code class="docutils literal notranslate"><span class="pre">a</span></code>: <code class="docutils literal notranslate"><span class="pre">a[i*rn</span> <span class="pre">+</span> <span class="pre">j]</span></code>, <code class="docutils literal notranslate"><span class="pre">a[(i+1)*rn</span> <span class="pre">+</span> <span class="pre">j]</span></code></p></li>
<li><p>Four reads of <code class="docutils literal notranslate"><span class="pre">c</span></code>: <code class="docutils literal notranslate"><span class="pre">c[k*rn</span> <span class="pre">+</span> <span class="pre">j]</span></code>, <code class="docutils literal notranslate"><span class="pre">c[(k+1)*rn</span> <span class="pre">+</span> <span class="pre">j]</span></code>, <code class="docutils literal notranslate"><span class="pre">c[(k+2)*rn</span> <span class="pre">+</span> <span class="pre">j]</span></code>,
<code class="docutils literal notranslate"><span class="pre">c[(k+3)*rn</span> <span class="pre">+</span> <span class="pre">j]</span></code></p></li>
<li><p>Two writes to <code class="docutils literal notranslate"><span class="pre">a</span></code>: <code class="docutils literal notranslate"><span class="pre">a[i*rn</span> <span class="pre">+</span> <span class="pre">j]</span></code>, <code class="docutils literal notranslate"><span class="pre">a[(i+1)*rn</span> <span class="pre">+</span> <span class="pre">j]</span></code></p></li>
</ul>
<p>Thus we are now at one memory access per <code class="docutils literal notranslate"><span class="pre">fma</span></code> operation rather than three as
in the original code.</p>
<p>What stops us from improving the ratio between compute and memory reference even
further by choosing even larger blocking factors? The most concrete limiting factor
is the additional number of registers that would be needed for the <code class="docutils literal notranslate"><span class="pre">bik</span></code>
variables. These depend on both <code class="docutils literal notranslate"><span class="pre">i</span></code> and <code class="docutils literal notranslate"><span class="pre">k</span></code> but are independent of
<code class="docutils literal notranslate"><span class="pre">j</span></code> which is why they are loop invariant. There are 16 vector registers in the
architecture and we need a few for common subexpressions or similar. So 4 by 4
or larger would lead to some of the <code class="docutils literal notranslate"><span class="pre">bik</span></code> being spilled to memory by the compiler.</p>
<div class="admonition-example admonition">
<p class="admonition-title">Example</p>
<p>Let us look at what the generated code looks like for the inner loop:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>gcc<span class="w"> </span>-O3<span class="w"> </span>-march<span class="o">=</span>native<span class="w"> </span>-S<span class="w"> </span>-o<span class="w"> </span>mmDb.s<span class="w"> </span>-fopenmp<span class="w"> </span>-DRTVL<span class="w"> </span>ex-mm-block.c
</pre></div>
</div>
<p>Here is the inner loop:</p>
<div class="highlight-asm notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="nl">.L5:</span>
<span class="linenos"> 2</span><span class="w">        </span><span class="nf">vmovupd</span><span class="w"> </span><span class="p">(</span><span class="nv">%rcx</span><span class="p">,</span><span class="nv">%rax</span><span class="p">),</span><span class="w"> </span><span class="nv">%ymm1</span><span class="w">                </span><span class="c1">; Read from c</span>
<span class="linenos"> 3</span><span class="w">        </span><span class="nf">vmovapd</span><span class="w"> </span><span class="nv">%ymm10</span><span class="p">,</span><span class="w"> </span><span class="nv">%ymm0</span><span class="w">                     </span><span class="c1">; ymm0 will be overwritten</span>
<span class="linenos"> 4</span><span class="w">        </span><span class="nf">vfmadd213pd</span><span class="w">     </span><span class="p">(</span><span class="nv">%r15</span><span class="p">,</span><span class="nv">%rax</span><span class="p">),</span><span class="w"> </span><span class="nv">%ymm1</span><span class="p">,</span><span class="w"> </span><span class="nv">%ymm0</span><span class="w"> </span><span class="c1">; fma, a[...] is first operand</span>
<span class="linenos"> 5</span><span class="w">        </span><span class="nf">vfmadd213pd</span><span class="w">     </span><span class="p">(</span><span class="nv">%r14</span><span class="p">,</span><span class="nv">%rax</span><span class="p">),</span><span class="w"> </span><span class="nv">%ymm9</span><span class="p">,</span><span class="w"> </span><span class="nv">%ymm1</span><span class="w"> </span><span class="c1">; fma, a[...] is first operand</span>
<span class="linenos"> 6</span><span class="w">        </span><span class="nf">vmovupd</span><span class="w"> </span><span class="p">(</span><span class="nv">%r10</span><span class="p">,</span><span class="nv">%rax</span><span class="p">),</span><span class="w"> </span><span class="nv">%ymm2</span><span class="w">                </span><span class="c1">; Read from c</span>
<span class="linenos"> 7</span><span class="w">        </span><span class="nf">vfmadd231pd</span><span class="w">     </span><span class="nv">%ymm2</span><span class="p">,</span><span class="w"> </span><span class="nv">%ymm8</span><span class="p">,</span><span class="w"> </span><span class="nv">%ymm0</span><span class="w">       </span><span class="c1">; fma</span>
<span class="linenos"> 8</span><span class="w">        </span><span class="nf">vfmadd231pd</span><span class="w">     </span><span class="nv">%ymm2</span><span class="p">,</span><span class="w"> </span><span class="nv">%ymm7</span><span class="p">,</span><span class="w"> </span><span class="nv">%ymm1</span><span class="w">       </span><span class="c1">; fma</span>
<span class="linenos"> 9</span><span class="w">        </span><span class="nf">vmovupd</span><span class="w"> </span><span class="p">(</span><span class="nv">%rdx</span><span class="p">,</span><span class="nv">%rax</span><span class="p">),</span><span class="w"> </span><span class="nv">%ymm2</span><span class="w">                </span><span class="c1">; Read from c</span>
<span class="linenos">10</span><span class="w">        </span><span class="nf">vfmadd231pd</span><span class="w">     </span><span class="nv">%ymm2</span><span class="p">,</span><span class="w"> </span><span class="nv">%ymm6</span><span class="p">,</span><span class="w"> </span><span class="nv">%ymm0</span><span class="w">       </span><span class="c1">; fma</span>
<span class="linenos">11</span><span class="w">        </span><span class="nf">vfmadd132pd</span><span class="w">     </span><span class="nv">%ymm5</span><span class="p">,</span><span class="w"> </span><span class="nv">%ymm1</span><span class="p">,</span><span class="w"> </span><span class="nv">%ymm2</span><span class="w">       </span><span class="c1">; fma (partial sum written to ymm2)</span>
<span class="linenos">12</span><span class="w">        </span><span class="nf">vmovupd</span><span class="w"> </span><span class="p">(</span><span class="nv">%rsi</span><span class="p">,</span><span class="nv">%rax</span><span class="p">),</span><span class="w"> </span><span class="nv">%ymm1</span><span class="w">                </span><span class="c1">; Read from c</span>
<span class="linenos">13</span><span class="w">        </span><span class="nf">vfmadd231pd</span><span class="w">     </span><span class="nv">%ymm1</span><span class="p">,</span><span class="w"> </span><span class="nv">%ymm4</span><span class="p">,</span><span class="w"> </span><span class="nv">%ymm0</span><span class="w">       </span><span class="c1">; fma</span>
<span class="linenos">14</span><span class="w">        </span><span class="nf">vfmadd132pd</span><span class="w">     </span><span class="nv">%ymm3</span><span class="p">,</span><span class="w"> </span><span class="nv">%ymm2</span><span class="p">,</span><span class="w"> </span><span class="nv">%ymm1</span><span class="w">       </span><span class="c1">; fma</span>
<span class="linenos">15</span><span class="w">        </span><span class="nf">vmovupd</span><span class="w"> </span><span class="nv">%ymm0</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="nv">%r15</span><span class="p">,</span><span class="nv">%rax</span><span class="p">)</span><span class="w">                </span><span class="c1">; Write to a</span>
<span class="linenos">16</span><span class="w">        </span><span class="nf">vmovupd</span><span class="w"> </span><span class="nv">%ymm1</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="nv">%r14</span><span class="p">,</span><span class="nv">%rax</span><span class="p">)</span><span class="w">                </span><span class="c1">; Write to a</span>
<span class="linenos">17</span><span class="w">        </span><span class="nf">addq</span><span class="w">    </span><span class="no">$32</span><span class="p">,</span><span class="w"> </span><span class="nv">%rax</span><span class="w">                         </span><span class="c1">; Increment offset</span>
<span class="linenos">18</span><span class="w">        </span><span class="nf">cmpq</span><span class="w">    </span><span class="nv">%rax</span><span class="p">,</span><span class="w"> </span><span class="nv">%rbx</span><span class="w">                        </span><span class="c1">; Are we done?</span>
<span class="linenos">19</span><span class="w">        </span><span class="nf">jne</span><span class="w">     </span><span class="no">.L5</span><span class="w">                               </span><span class="c1">; Loop back</span>
</pre></div>
</div>
<p>This is about as good code as you can expect. There are eight <code class="docutils literal notranslate"><span class="pre">fma</span></code> instructions
and eight memory references, two of which are combined with the compute operatons.
There are three different variants of the <code class="docutils literal notranslate"><span class="pre">fma</span></code> instruction used. They differ
in which instruction operand plays what role in the computation. The reason for
the different variants is that there are two operands that are special:</p>
<ul class="simple">
<li><p>The first operand can be read from memory.</p></li>
<li><p>The third operand will be both read and written (since the instruction format
does not accomodate four operands).</p></li>
</ul>
<p>Note also that the memory references use different base registers together with
a common offset in <code class="docutils literal notranslate"><span class="pre">rax</span></code>.</p>
<p>In total, there are 18 instructions in the loop body. With an ideal execution
rate of four instructions per cycle, this amounts to 4.5 cycles for 8 vector
<code class="docutils literal notranslate"><span class="pre">fma</span></code> operations or a 0.14 cycles per scalar <code class="docutils literal notranslate"><span class="pre">fma</span></code>.</p>
</div>
<div class="admonition-exercise exercise important admonition" id="exercise-10">
<p class="admonition-title">Exercise</p>
<p>Explore the performance effect of register blocking!
Compile with</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>gcc<span class="w"> </span>-O3<span class="w"> </span>-march<span class="o">=</span>native<span class="w"> </span>-fopenmp<span class="w"> </span>-DRTVL<span class="w"> </span>-o<span class="w"> </span>mmDb<span class="w"> </span>ex-mm-block.c<span class="w"> </span>ex-mm-main.c<span class="w"> </span>-lm
</pre></div>
</div>
<p>Do we get any performance difference?</p>
</div>
<div class="admonition-solution solution important dropdown admonition" id="solution-10">
<p class="admonition-title">Solution</p>
<p>On the Core i7-8550U, we get the following:</p>
<img alt="../_images/mm4-cpi.png" class="align-center" src="../_images/mm4-cpi.png" />
<p>We see a huge improvement in performance, in fact almost a factor of three
for size 100 where we reach about 0.2 cycles per <code class="docutils literal notranslate"><span class="pre">fma</span></code>. For larger matrix
sizes we see a small slowdown until about 250 with similar perfromance out
to 600. For that size range, the working set of the algorithm fits in the L3
cache.</p>
<p>We see that we are still quite a bit from the ideal performance of 0.125 cycles
per scalar <code class="docutils literal notranslate"><span class="pre">fma</span></code> or the ideal inner loop performance of 0.14 cycles per
scalar <code class="docutils literal notranslate"><span class="pre">fma</span></code>.</p>
</div>
</section>
<section id="blocking-for-the-cache">
<h2>Blocking for the cache<a class="headerlink" href="#blocking-for-the-cache" title="Permalink to this heading"></a></h2>
<p>For the larger matrix sizes, we lose some time to cache misses, so it seems
worthwhile to try blocking for the cache as well. The goal of this blocking is
the <code class="docutils literal notranslate"><span class="pre">c</span></code> matrix which is indexed by
<code class="docutils literal notranslate"><span class="pre">k</span></code> and <code class="docutils literal notranslate"><span class="pre">j</span></code> and hence independent of
<code class="docutils literal notranslate"><span class="pre">i</span></code>. So if we could limit the amount of data from this matrix touched within
each iteration of the <code class="docutils literal notranslate"><span class="pre">i</span></code> loop, then that data would fit in the L1 or L2 caches.</p>
<p>Here is the code:</p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-3-3-0" aria-selected="true" class="sphinx-tabs-tab" id="tab-3-3-0" name="3-0" role="tab" tabindex="0">C</button><button aria-controls="panel-3-3-1" aria-selected="false" class="sphinx-tabs-tab" id="tab-3-3-1" name="3-1" role="tab" tabindex="-1">Fortran</button></div><div aria-labelledby="tab-3-3-0" class="sphinx-tabs-panel" id="panel-3-3-0" name="3-0" role="tabpanel" tabindex="0"><div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;rtvl.h&quot;</span>
<span class="linenos"> 2</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;string.h&gt;</span>
<span class="linenos"> 3</span>
<span class="linenos"> 4</span><span class="kt">void</span><span class="w"> </span><span class="nf">matmul</span><span class="p">(</span><span class="kt">double</span><span class="o">*</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="kt">double</span><span class="o">*</span><span class="w"> </span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="kt">double</span><span class="o">*</span><span class="w"> </span><span class="n">c</span><span class="p">,</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos"> 5</span><span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">rn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rtvl</span><span class="p">(</span><span class="n">n</span><span class="p">);</span>
<span class="linenos"> 6</span><span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">n</span><span class="o">%</span><span class="mi">4</span><span class="p">;</span>
<span class="linenos"> 7</span><span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">jb</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">512</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="mi">512</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">n</span><span class="p">;</span>
<span class="linenos"> 8</span><span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">kb</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">256</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="mi">1024</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">jb</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mi">16</span><span class="p">;</span>
<span class="linenos"> 9</span><span class="w">  </span><span class="k">for</span><span class="p">(</span><span class="kt">long</span><span class="w"> </span><span class="n">jj</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">jj</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">n</span><span class="p">;</span><span class="w"> </span><span class="n">jj</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">jb</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">10</span><span class="w">    </span><span class="kt">long</span><span class="w"> </span><span class="n">jlim</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">jj</span><span class="o">+</span><span class="n">jb</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">jj</span><span class="o">+</span><span class="n">jb</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">n</span><span class="p">;</span>
<span class="linenos">11</span><span class="w">    </span><span class="k">for</span><span class="p">(</span><span class="kt">long</span><span class="w"> </span><span class="n">kk</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">kk</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">n</span><span class="p">;</span><span class="w"> </span><span class="n">kk</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">kb</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">12</span><span class="w">      </span><span class="kt">long</span><span class="w"> </span><span class="n">klim</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kk</span><span class="o">+</span><span class="n">kb</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">kk</span><span class="o">+</span><span class="n">kb</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">n</span><span class="p">;</span>
<span class="linenos">13</span><span class="w">      </span><span class="k">for</span><span class="p">(</span><span class="kt">long</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">n</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">+=</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">14</span><span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="n">kk</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">15</span><span class="w">          </span><span class="n">memset</span><span class="p">(</span><span class="n">a</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">0</span><span class="p">)</span><span class="o">*</span><span class="n">rn</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">jj</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">jlim</span><span class="o">-</span><span class="n">jj</span><span class="p">)</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">double</span><span class="p">));</span>
<span class="linenos">16</span><span class="w">          </span><span class="n">memset</span><span class="p">(</span><span class="n">a</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">rn</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">jj</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">jlim</span><span class="o">-</span><span class="n">jj</span><span class="p">)</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">double</span><span class="p">));</span>
<span class="linenos">17</span><span class="w">        </span><span class="p">}</span>
<span class="linenos">18</span><span class="w">        </span><span class="k">for</span><span class="p">(</span><span class="kt">long</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kk</span><span class="p">;</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">klim</span><span class="mi">-3</span><span class="p">;</span><span class="w"> </span><span class="n">k</span><span class="o">+=</span><span class="mi">4</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">19</span><span class="w">          </span><span class="kt">double</span><span class="w"> </span><span class="n">b00</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">b</span><span class="p">[(</span><span class="n">i</span><span class="o">+</span><span class="mi">0</span><span class="p">)</span><span class="o">*</span><span class="n">rn</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">0</span><span class="p">];</span>
<span class="linenos">20</span><span class="w">          </span><span class="kt">double</span><span class="w"> </span><span class="n">b01</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">b</span><span class="p">[(</span><span class="n">i</span><span class="o">+</span><span class="mi">0</span><span class="p">)</span><span class="o">*</span><span class="n">rn</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">];</span>
<span class="linenos">21</span><span class="w">          </span><span class="kt">double</span><span class="w"> </span><span class="n">b02</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">b</span><span class="p">[(</span><span class="n">i</span><span class="o">+</span><span class="mi">0</span><span class="p">)</span><span class="o">*</span><span class="n">rn</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span><span class="p">];</span>
<span class="linenos">22</span><span class="w">          </span><span class="kt">double</span><span class="w"> </span><span class="n">b03</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">b</span><span class="p">[(</span><span class="n">i</span><span class="o">+</span><span class="mi">0</span><span class="p">)</span><span class="o">*</span><span class="n">rn</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">3</span><span class="p">];</span>
<span class="linenos">23</span><span class="w">          </span><span class="kt">double</span><span class="w"> </span><span class="n">b10</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">b</span><span class="p">[(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">rn</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">0</span><span class="p">];</span>
<span class="linenos">24</span><span class="w">          </span><span class="kt">double</span><span class="w"> </span><span class="n">b11</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">b</span><span class="p">[(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">rn</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">];</span>
<span class="linenos">25</span><span class="w">          </span><span class="kt">double</span><span class="w"> </span><span class="n">b12</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">b</span><span class="p">[(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">rn</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span><span class="p">];</span>
<span class="linenos">26</span><span class="w">          </span><span class="kt">double</span><span class="w"> </span><span class="n">b13</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">b</span><span class="p">[(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">rn</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">3</span><span class="p">];</span>
<span class="linenos">27</span><span class="w">          </span><span class="cp">#pragma omp simd</span>
<span class="linenos">28</span><span class="w">          </span><span class="k">for</span><span class="p">(</span><span class="kt">long</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">jj</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">jlim</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">29</span><span class="w">            </span><span class="kt">double</span><span class="w"> </span><span class="n">s0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="n">rn</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">j</span><span class="p">];</span>
<span class="linenos">30</span><span class="w">            </span><span class="kt">double</span><span class="w"> </span><span class="n">s1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">a</span><span class="p">[(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">rn</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">j</span><span class="p">];</span>
<span class="linenos">31</span><span class="w">            </span><span class="n">s0</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">b00</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">c</span><span class="p">[</span><span class="n">k</span><span class="o">*</span><span class="n">rn</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">j</span><span class="p">];</span>
<span class="linenos">32</span><span class="w">            </span><span class="n">s1</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">b10</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">c</span><span class="p">[</span><span class="n">k</span><span class="o">*</span><span class="n">rn</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">j</span><span class="p">];</span>
<span class="linenos">33</span><span class="w">            </span><span class="n">s0</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">b01</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">c</span><span class="p">[(</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">rn</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">j</span><span class="p">];</span>
<span class="linenos">34</span><span class="w">            </span><span class="n">s1</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">b11</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">c</span><span class="p">[(</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">rn</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">j</span><span class="p">];</span>
<span class="linenos">35</span><span class="w">            </span><span class="n">s0</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">b02</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">c</span><span class="p">[(</span><span class="n">k</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">rn</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">j</span><span class="p">];</span>
<span class="linenos">36</span><span class="w">            </span><span class="n">s1</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">b12</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">c</span><span class="p">[(</span><span class="n">k</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">rn</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">j</span><span class="p">];</span>
<span class="linenos">37</span><span class="w">            </span><span class="n">s0</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">b03</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">c</span><span class="p">[(</span><span class="n">k</span><span class="o">+</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="n">rn</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">j</span><span class="p">];</span>
<span class="linenos">38</span><span class="w">            </span><span class="n">s1</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">b13</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">c</span><span class="p">[(</span><span class="n">k</span><span class="o">+</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="n">rn</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">j</span><span class="p">];</span>
<span class="linenos">39</span><span class="w">            </span><span class="n">a</span><span class="p">[</span><span class="w">    </span><span class="n">i</span><span class="o">*</span><span class="n">rn</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">j</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">s0</span><span class="p">;</span>
<span class="linenos">40</span><span class="w">            </span><span class="n">a</span><span class="p">[(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">rn</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">j</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">s1</span><span class="p">;</span>
<span class="linenos">41</span><span class="w">          </span><span class="p">}</span>
<span class="linenos">42</span><span class="w">        </span><span class="p">}</span>
<span class="linenos">43</span><span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="n">klim</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">44</span><span class="w">          </span><span class="k">for</span><span class="p">(</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">n</span><span class="o">-</span><span class="n">m</span><span class="p">;</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">n</span><span class="p">;</span><span class="w"> </span><span class="n">k</span><span class="o">++</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">45</span><span class="w">            </span><span class="cp">#pragma omp simd</span>
<span class="linenos">46</span><span class="w">            </span><span class="k">for</span><span class="p">(</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">jj</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">jlim</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="o">++</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">47</span><span class="w">              </span><span class="n">a</span><span class="p">[</span><span class="w">    </span><span class="n">i</span><span class="o">*</span><span class="n">rn</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">j</span><span class="p">]</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">b</span><span class="p">[</span><span class="w">    </span><span class="n">i</span><span class="o">*</span><span class="n">rn</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">k</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">c</span><span class="p">[</span><span class="n">k</span><span class="o">*</span><span class="n">rn</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">j</span><span class="p">];</span>
<span class="linenos">48</span><span class="w">              </span><span class="n">a</span><span class="p">[(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">rn</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">j</span><span class="p">]</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">b</span><span class="p">[(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">rn</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">k</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">c</span><span class="p">[</span><span class="n">k</span><span class="o">*</span><span class="n">rn</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">j</span><span class="p">];</span>
<span class="linenos">49</span><span class="w">            </span><span class="p">}</span>
<span class="linenos">50</span><span class="w">          </span><span class="p">}</span>
<span class="linenos">51</span><span class="w">        </span><span class="p">}</span>
<span class="linenos">52</span><span class="w">      </span><span class="p">}</span>
<span class="linenos">53</span><span class="w">    </span><span class="p">}</span>
<span class="linenos">54</span><span class="w">  </span><span class="p">}</span>
<span class="linenos">55</span><span class="p">}</span>
</pre></div>
</div>
</div><div aria-labelledby="tab-3-3-1" class="sphinx-tabs-panel" hidden="true" id="panel-3-3-1" name="3-1" role="tabpanel" tabindex="0"><div class="highlight-fortran notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="k">module </span><span class="n">matmul_module</span>
<span class="linenos"> 2</span><span class="w">  </span><span class="k">use </span><span class="n">rtvl_module</span>
<span class="linenos"> 3</span><span class="w">  </span><span class="k">implicit none</span>
<span class="linenos"> 4</span><span class="k">contains</span>
<span class="linenos"> 5</span><span class="k">  subroutine </span><span class="nb">matmul</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="n">c</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">)</span>
<span class="linenos"> 6</span><span class="w">    </span><span class="kt">integer</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">n</span>
<span class="linenos"> 7</span><span class="w">    </span><span class="kt">double precision</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">a</span><span class="p">(</span><span class="n">rtvl</span><span class="p">(</span><span class="n">n</span><span class="p">),</span><span class="n">n</span><span class="p">)</span>
<span class="linenos"> 8</span><span class="w">    </span><span class="kt">double precision</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">b</span><span class="p">(</span><span class="n">rtvl</span><span class="p">(</span><span class="n">n</span><span class="p">),</span><span class="n">n</span><span class="p">),</span><span class="w"> </span><span class="n">c</span><span class="p">(</span><span class="n">rtvl</span><span class="p">(</span><span class="n">n</span><span class="p">),</span><span class="n">n</span><span class="p">)</span>
<span class="linenos"> 9</span><span class="w">    </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">,</span><span class="w"> </span><span class="n">rn</span><span class="p">,</span><span class="w"> </span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="n">ib</span><span class="p">,</span><span class="w"> </span><span class="n">kb</span><span class="p">,</span><span class="w"> </span><span class="n">ii</span><span class="p">,</span><span class="w"> </span><span class="n">kk</span><span class="p">,</span><span class="w"> </span><span class="n">ilim</span><span class="p">,</span><span class="w"> </span><span class="n">klim</span>
<span class="linenos">10</span><span class="w">    </span><span class="kt">double precision</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">c00</span><span class="p">,</span><span class="w"> </span><span class="n">c10</span><span class="p">,</span><span class="w"> </span><span class="n">c20</span><span class="p">,</span><span class="w"> </span><span class="n">c30</span><span class="p">,</span><span class="w"> </span><span class="n">c01</span><span class="p">,</span><span class="w"> </span><span class="n">c11</span><span class="p">,</span><span class="w"> </span><span class="n">c21</span><span class="p">,</span><span class="w"> </span><span class="n">c31</span>
<span class="linenos">11</span><span class="w">    </span><span class="kt">double precision</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">s0</span><span class="p">,</span><span class="w"> </span><span class="n">s1</span>
<span class="linenos">12</span>
<span class="linenos">13</span><span class="w">    </span><span class="n">rn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rtvl</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
<span class="linenos">14</span><span class="w">    </span><span class="n">m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">mod</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">)</span>
<span class="linenos">15</span>
<span class="linenos">16</span><span class="w">    </span><span class="n">ib</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">merge</span><span class="p">(</span><span class="mi">512</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">512</span><span class="p">)</span>
<span class="linenos">17</span><span class="w">    </span><span class="n">kb</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">merge</span><span class="p">(</span><span class="mi">4</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="mi">1024</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">ib</span><span class="p">),</span><span class="w"> </span><span class="mi">16</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">256</span><span class="p">)</span>
<span class="linenos">18</span>
<span class="linenos">19</span><span class="w">    </span><span class="k">do </span><span class="n">ii</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n">ib</span>
<span class="linenos">20</span><span class="w">      </span><span class="n">ilim</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">min</span><span class="p">(</span><span class="n">ii</span><span class="o">+</span><span class="n">ib</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">)</span>
<span class="linenos">21</span><span class="w">      </span><span class="k">do </span><span class="n">kk</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n">kb</span>
<span class="linenos">22</span><span class="w">        </span><span class="n">klim</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">min</span><span class="p">(</span><span class="n">kk</span><span class="o">+</span><span class="n">kb</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">)</span>
<span class="linenos">23</span><span class="w">        </span><span class="k">do </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span>
<span class="linenos">24</span><span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">kk</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">25</span><span class="k">            </span><span class="n">a</span><span class="p">(</span><span class="n">ii</span><span class="p">:</span><span class="n">ilim</span><span class="p">,</span><span class="n">j</span><span class="p">:</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>
<span class="linenos">26</span><span class="w">          </span><span class="k">end if</span>
<span class="linenos">27</span><span class="k">          do </span><span class="n">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kk</span><span class="p">,</span><span class="w"> </span><span class="n">klim</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span>
<span class="linenos">28</span><span class="w">            </span><span class="n">c00</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">c</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="w">  </span><span class="n">j</span><span class="p">)</span>
<span class="linenos">29</span><span class="w">            </span><span class="n">c10</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">c</span><span class="p">(</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">)</span>
<span class="linenos">30</span><span class="w">            </span><span class="n">c20</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">c</span><span class="p">(</span><span class="n">k</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span><span class="n">j</span><span class="p">)</span>
<span class="linenos">31</span><span class="w">            </span><span class="n">c30</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">c</span><span class="p">(</span><span class="n">k</span><span class="o">+</span><span class="mi">3</span><span class="p">,</span><span class="n">j</span><span class="p">)</span>
<span class="linenos">32</span><span class="w">            </span><span class="n">c01</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">c</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="w">  </span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
<span class="linenos">33</span><span class="w">            </span><span class="n">c11</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">c</span><span class="p">(</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
<span class="linenos">34</span><span class="w">            </span><span class="n">c21</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">c</span><span class="p">(</span><span class="n">k</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
<span class="linenos">35</span><span class="w">            </span><span class="n">c31</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">c</span><span class="p">(</span><span class="n">k</span><span class="o">+</span><span class="mi">3</span><span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
<span class="linenos">36</span><span class="w">            </span><span class="k">do </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ii</span><span class="p">,</span><span class="w"> </span><span class="n">ilim</span>
<span class="linenos">37</span><span class="w">              </span><span class="n">s0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">a</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">)</span>
<span class="linenos">38</span><span class="w">              </span><span class="n">s1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">a</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
<span class="linenos">39</span><span class="w">              </span><span class="n">s0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">s0</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">b</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">k</span><span class="o">+</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">c00</span>
<span class="linenos">40</span><span class="w">              </span><span class="n">s1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">s1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">b</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">k</span><span class="o">+</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">c01</span>
<span class="linenos">41</span><span class="w">              </span><span class="n">s0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">s0</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">b</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">c10</span>
<span class="linenos">42</span><span class="w">              </span><span class="n">s1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">s1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">b</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">c11</span>
<span class="linenos">43</span><span class="w">              </span><span class="n">s0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">s0</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">b</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">k</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">c20</span>
<span class="linenos">44</span><span class="w">              </span><span class="n">s1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">s1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">b</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">k</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">c21</span>
<span class="linenos">45</span><span class="w">              </span><span class="n">s0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">s0</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">b</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">k</span><span class="o">+</span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">c30</span>
<span class="linenos">46</span><span class="w">              </span><span class="n">s1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">s1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">b</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">k</span><span class="o">+</span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">c31</span>
<span class="linenos">47</span><span class="w">              </span><span class="n">a</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">)</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="n">s0</span>
<span class="linenos">48</span><span class="w">              </span><span class="n">a</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">s1</span>
<span class="linenos">49</span><span class="w">            </span><span class="k">end do</span>
<span class="linenos">50</span><span class="k">          end do</span>
<span class="linenos">51</span><span class="k">          if</span><span class="w"> </span><span class="p">(</span><span class="n">klim</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="linenos">52</span><span class="k">            do </span><span class="n">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">n</span><span class="o">-</span><span class="n">m</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">n</span>
<span class="linenos">53</span><span class="w">              </span><span class="k">do </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ii</span><span class="p">,</span><span class="w"> </span><span class="n">ilim</span>
<span class="linenos">54</span><span class="w">                </span><span class="n">a</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">)</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">a</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">)</span><span class="w">   </span><span class="o">+</span><span class="w"> </span><span class="n">b</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">c</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">j</span><span class="p">)</span>
<span class="linenos">55</span><span class="w">                </span><span class="n">a</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">=</span><span class="w"> </span><span class="n">a</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">b</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">c</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
<span class="linenos">56</span><span class="w">              </span><span class="k">end do</span>
<span class="linenos">57</span><span class="k">            end do</span>
<span class="linenos">58</span><span class="k">          end if</span>
<span class="linenos">59</span><span class="k">        end do</span>
<span class="linenos">60</span><span class="k">      end do</span>
<span class="linenos">61</span><span class="k">    end do</span>
<span class="linenos">62</span><span class="k">  end subroutine </span><span class="nb">matmul</span>
<span class="linenos">63</span><span class="k">end module </span><span class="n">matmul_module</span>
</pre></div>
</div>
</div></div>
<div class="admonition-exercise exercise important admonition" id="exercise-11">
<p class="admonition-title">Exercise</p>
<p>Explore the performance effect of cache and register blocking!
Compile with</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>gcc<span class="w"> </span>-O3<span class="w"> </span>-march<span class="o">=</span>native<span class="w"> </span>-fopenmp<span class="w"> </span>-DRTVL<span class="w"> </span>-o<span class="w"> </span>mmDbb<span class="w"> </span>ex-mm-bigblock.c<span class="w"> </span>ex-mm-main.c<span class="w"> </span>-lm
</pre></div>
</div>
<p>Do we get any performance difference?</p>
</div>
<div class="admonition-solution solution important dropdown admonition" id="solution-11">
<p class="admonition-title">Solution</p>
<p>On the Core i7-8550U, we get the following:</p>
<img alt="../_images/mm5-cpi.png" class="align-center" src="../_images/mm5-cpi.png" />
<p>As expected, we see no difference for small matrices, but from 150 and up we
see some improvements.</p>
</div>
<p>Can we do even better? We have an inner loop with as many <code class="docutils literal notranslate"><span class="pre">fma</span></code> operations as
memory accesses and it is difficult to improve on that ratio without risking to
run out of vector registers. The main problem is still that we both read
and write the partial sums in the <code class="docutils literal notranslate"><span class="pre">a</span></code> matrix, a consequence of the DAXPY loop
ordering. In order to push further, we need to explore the alternative to
the DAXPY loop ordering that we considered above.</p>
</section>
<section id="explicit-vectorization">
<h2>Explicit vectorization<a class="headerlink" href="#explicit-vectorization" title="Permalink to this heading"></a></h2>
<p>We now return to having the <code class="docutils literal notranslate"><span class="pre">k</span></code> loop as the innermost loop, just as in the
textbook definition of matrix multiplication. We will however compute several
sums in parallel.</p>
<p>In contrast to the development of the DAXPY variant, we will only present the
final version, which is vectorized and blocked for registers, L1 and L3.</p>
<p>In contrast to the DAXPY versions, we have used explicit vectorization. With
the loop structure we use in this code, we could not get the compiler to
vecorize reliably. We use the vector constructs implemented by GCC and Clang
and thus we avoid using vector intrinsics. The vectorization is requested by
declaring a vector type:</p>
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="k">typedef</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="nf">__attribute__</span><span class="p">((</span><span class="n">vector_size</span><span class="p">(</span><span class="mi">32</span><span class="p">)))</span><span class="w"> </span><span class="n">v4d_t</span><span class="p">;</span>
</pre></div>
</div>
<p>This declaration creates a type of vectors of <code class="docutils literal notranslate"><span class="pre">double</span></code> of size 32 bytes.
Since a <code class="docutils literal notranslate"><span class="pre">double</span></code> is eight bytes in size, such a vector has four elements.</p>
<p>With this type declaration in hand we can now create arrays of such vectors
in the usual way and we can also add, multiply, etc using the ordinary C operators.
Vector variables can be initialized using the <code class="docutils literal notranslate"><span class="pre">{...}</span></code> syntax and can also be
indexed to retrieve individual components.</p>
<p>We use vector access for the <code class="docutils literal notranslate"><span class="pre">a</span></code> and <code class="docutils literal notranslate"><span class="pre">c</span></code> matrices, accessing them through
pointers of type <code class="docutils literal notranslate"><span class="pre">v4d_t*</span></code>. We have vectorized in the
<code class="docutils literal notranslate"><span class="pre">j</span></code> dimension, which is the stride 1 direction for these matrices.
From the <code class="docutils literal notranslate"><span class="pre">b</span></code> matrix, the accesses are invariant with respect to
<code class="docutils literal notranslate"><span class="pre">j</span></code> which means that we want to do scalar-vector multiplication with
<code class="docutils literal notranslate"><span class="pre">c</span></code>. This functionality is also supported by the vector programming model.</p>
<p>We have also used the <code class="docutils literal notranslate"><span class="pre">unroll</span></code> pragma of GCC. Together with constant loop bounds,
this guarantees that the loops are completely unrolled and that arrays used in the
loop and indexed with the associated index variables will be converted to sets of
scalar variables. We could not use this construct in the DAXPY versions since the
presence of inner loops, even if they were marked for complete unroll, disabled
vectorization.</p>
<p>We use transpose of the <code class="docutils literal notranslate"><span class="pre">c</span></code> matrix, which is a common optimization with
this loop ordering. Consider the innermost loop (without other optimizations):</p>
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="k">for</span><span class="p">(</span><span class="kt">long</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">n</span><span class="p">;</span><span class="w"> </span><span class="n">k</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">sum</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">b</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="n">n</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">k</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">c</span><span class="p">[</span><span class="n">k</span><span class="o">*</span><span class="n">n</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">j</span><span class="p">];</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">b</span></code> matrix is accessed with unit stride (for row major layout) since
<code class="docutils literal notranslate"><span class="pre">k</span></code> has coefficient 1 in the index expression. In contrast,
<code class="docutils literal notranslate"><span class="pre">k</span></code> has <code class="docutils literal notranslate"><span class="pre">n</span></code> as coefficient in the access to the
<code class="docutils literal notranslate"><span class="pre">c</span></code> matrix. Hence it is a good idea to transpose this matrix and instead
use the following code:</p>
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="k">for</span><span class="p">(</span><span class="kt">long</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">n</span><span class="p">;</span><span class="w"> </span><span class="n">k</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">sum</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">b</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="n">n</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">k</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">cT</span><span class="p">[</span><span class="n">k</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">j</span><span class="o">*</span><span class="n">n</span><span class="p">];</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Here <code class="docutils literal notranslate"><span class="pre">cT</span></code> is the transposed version.</p>
<p>In this version of the code, we do the transpose for blocks of the <code class="docutils literal notranslate"><span class="pre">c</span></code> matrix
rather than once for the whole matrix. This gives us a block of the transposed
matrix stored contiguously, eliminating the risk of cache conflicts between rows.</p>
<p>We combine the transpose with vectorization
by transposing the vectorized version of the <code class="docutils literal notranslate"><span class="pre">c</span></code> matrix. We thus essentially get
a three dimensional array as <code class="docutils literal notranslate"><span class="pre">c</span></code>-block, with <code class="docutils literal notranslate"><span class="pre">j</span></code> as the outermost dimension,
<code class="docutils literal notranslate"><span class="pre">k</span></code> as the middle dimension and then <code class="docutils literal notranslate"><span class="pre">j</span></code> again within the SIMD vector words.</p>
<p>For simplicity, this version of the code only handles matrix sizes that are
mutiples of 16.</p>
<p>Here is
the code:</p>
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;malloc.h&gt;</span>
<span class="linenos"> 2</span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdlib.h&gt;</span>
<span class="linenos"> 3</span>
<span class="linenos"> 4</span><span class="k">typedef</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="nf">__attribute__</span><span class="p">((</span><span class="n">vector_size</span><span class="p">(</span><span class="mi">32</span><span class="p">)))</span><span class="w"> </span><span class="n">v4d_t</span><span class="p">;</span>
<span class="linenos"> 5</span>
<span class="linenos"> 6</span><span class="cp">#define YB 4</span>
<span class="linenos"> 7</span><span class="cp">#define XB 2</span>
<span class="linenos"> 8</span><span class="k">static</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">yB</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">YB</span><span class="p">;</span>
<span class="linenos"> 9</span><span class="k">static</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">xB</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">XB</span><span class="p">;</span>
<span class="linenos">10</span>
<span class="linenos">11</span><span class="cp">#define min(a,b) ((a) &lt; (b) ? (a) : (b))</span>
<span class="linenos">12</span>
<span class="linenos">13</span><span class="kt">void</span><span class="w"> </span><span class="nf">matmul</span><span class="p">(</span><span class="kt">double</span><span class="o">*</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="kt">double</span><span class="o">*</span><span class="w"> </span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="kt">double</span><span class="o">*</span><span class="w"> </span><span class="n">c</span><span class="p">,</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">14</span><span class="w">  </span><span class="n">v4d_t</span><span class="o">*</span><span class="w"> </span><span class="n">va</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">v4d_t</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="n">a</span><span class="p">;</span>
<span class="linenos">15</span><span class="w">  </span><span class="n">v4d_t</span><span class="o">*</span><span class="w"> </span><span class="n">vb</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">v4d_t</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="n">b</span><span class="p">;</span>
<span class="linenos">16</span><span class="w">  </span><span class="n">v4d_t</span><span class="o">*</span><span class="w"> </span><span class="n">vc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">v4d_t</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="n">c</span><span class="p">;</span>
<span class="linenos">17</span><span class="w">  </span><span class="k">_Alignas</span><span class="p">(</span><span class="mi">64</span><span class="p">)</span><span class="w"> </span><span class="n">v4d_t</span><span class="w"> </span><span class="n">vcT</span><span class="p">[</span><span class="mi">512</span><span class="p">];</span>
<span class="linenos">18</span><span class="w">  </span><span class="kt">long</span><span class="w"> </span><span class="n">JB</span><span class="w"> </span><span class="o">=</span><span class="w">  </span><span class="mi">8</span><span class="p">;</span>
<span class="linenos">19</span><span class="w">  </span><span class="kt">long</span><span class="w"> </span><span class="n">KB</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">64</span><span class="p">;</span>
<span class="linenos">20</span><span class="w">  </span><span class="kt">long</span><span class="w"> </span><span class="n">IB</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">512</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mi">4</span><span class="o">*</span><span class="n">KB</span><span class="p">;</span>
<span class="linenos">21</span><span class="w">    </span>
<span class="linenos">22</span><span class="w">  </span><span class="kt">long</span><span class="w"> </span><span class="n">KBB</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">IB</span><span class="p">;</span>
<span class="linenos">23</span><span class="w">  </span><span class="kt">long</span><span class="w"> </span><span class="n">no4</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">n</span><span class="o">/</span><span class="mi">4</span><span class="p">;</span>
<span class="linenos">24</span><span class="w">  </span><span class="kt">double</span><span class="o">*</span><span class="w"> </span><span class="n">cT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">double</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="n">vcT</span><span class="p">;</span>
<span class="linenos">25</span>
<span class="linenos">26</span><span class="w">  </span><span class="k">for</span><span class="p">(</span><span class="kt">long</span><span class="w"> </span><span class="n">ii</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">ii</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">n</span><span class="p">;</span><span class="w"> </span><span class="n">ii</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">IB</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">27</span><span class="w">    </span><span class="kt">long</span><span class="w"> </span><span class="n">ilim</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">min</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n">ii</span><span class="o">+</span><span class="n">IB</span><span class="p">);</span>
<span class="linenos">28</span><span class="w">    </span><span class="k">for</span><span class="p">(</span><span class="kt">long</span><span class="w"> </span><span class="n">kkk</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">kkk</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">n</span><span class="p">;</span><span class="w"> </span><span class="n">kkk</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">KBB</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">29</span><span class="w">      </span><span class="kt">long</span><span class="w"> </span><span class="n">kklim</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">min</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n">kkk</span><span class="o">+</span><span class="n">KBB</span><span class="p">);</span>
<span class="linenos">30</span><span class="w">      </span><span class="k">for</span><span class="p">(</span><span class="kt">long</span><span class="w"> </span><span class="n">jj</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">jj</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">no4</span><span class="p">;</span><span class="w"> </span><span class="n">jj</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">JB</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">31</span><span class="w">        </span><span class="kt">long</span><span class="w"> </span><span class="n">jlim</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">min</span><span class="p">(</span><span class="n">no4</span><span class="p">,</span><span class="w"> </span><span class="n">jj</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">JB</span><span class="p">);</span>
<span class="linenos">32</span><span class="w">        </span><span class="k">for</span><span class="p">(</span><span class="kt">long</span><span class="w"> </span><span class="n">kk</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kkk</span><span class="p">;</span><span class="w"> </span><span class="n">kk</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">kklim</span><span class="p">;</span><span class="w"> </span><span class="n">kk</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">KB</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">33</span><span class="w">          </span><span class="kt">long</span><span class="w"> </span><span class="n">klim</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">min</span><span class="p">(</span><span class="n">kklim</span><span class="p">,</span><span class="w"> </span><span class="n">kk</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">KB</span><span class="p">);</span>
<span class="linenos">34</span><span class="w">          </span><span class="kt">long</span><span class="w"> </span><span class="n">koff</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">klim</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">kk</span><span class="p">;</span>
<span class="linenos">35</span><span class="w">          </span><span class="c1">// Transpose part of the c matrix</span>
<span class="linenos">36</span><span class="w">          </span><span class="k">for</span><span class="p">(</span><span class="kt">long</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kk</span><span class="p">;</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">klim</span><span class="p">;</span><span class="w"> </span><span class="n">k</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">37</span><span class="w">            </span><span class="k">for</span><span class="p">(</span><span class="kt">long</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">jj</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">jlim</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="o">+=</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">38</span><span class="w">              </span><span class="n">vcT</span><span class="p">[(</span><span class="n">j</span><span class="o">-</span><span class="n">jj</span><span class="p">)</span><span class="o">*</span><span class="n">koff</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">k</span><span class="o">-</span><span class="n">kk</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vc</span><span class="p">[</span><span class="n">k</span><span class="o">*</span><span class="n">no4</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">j</span><span class="p">];</span>
<span class="linenos">39</span><span class="w">              </span><span class="n">vcT</span><span class="p">[(</span><span class="n">j</span><span class="o">-</span><span class="n">jj</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">koff</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">k</span><span class="o">-</span><span class="n">kk</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vc</span><span class="p">[</span><span class="n">k</span><span class="o">*</span><span class="n">no4</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">];</span>
<span class="linenos">40</span><span class="w">            </span><span class="p">}</span>
<span class="linenos">41</span><span class="w">          </span><span class="p">}</span>
<span class="linenos">42</span><span class="w">          </span><span class="k">for</span><span class="p">(</span><span class="kt">long</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ii</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">ilim</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">+=</span><span class="n">xB</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">43</span><span class="w">            </span><span class="k">for</span><span class="p">(</span><span class="kt">long</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">jj</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">jlim</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">yB</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">44</span><span class="w">              </span><span class="c1">// Prefetch the part of the a matrix that we will update</span>
<span class="linenos">45</span><span class="w">              </span><span class="cp">#pragma GCC unroll xB</span>
<span class="linenos">46</span><span class="w">              </span><span class="k">for</span><span class="p">(</span><span class="kt">long</span><span class="w"> </span><span class="n">ui</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">ui</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">xB</span><span class="p">;</span><span class="w"> </span><span class="n">ui</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">47</span><span class="w">                </span><span class="cp">#pragma GCC unroll yB/2</span>
<span class="linenos">48</span><span class="w">                </span><span class="k">for</span><span class="p">(</span><span class="kt">long</span><span class="w"> </span><span class="n">uj</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">uj</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">yB</span><span class="p">;</span><span class="w"> </span><span class="n">uj</span><span class="o">+=</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">49</span><span class="w">                  </span><span class="n">__builtin_prefetch</span><span class="p">(</span><span class="n">va</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="n">ui</span><span class="p">)</span><span class="o">*</span><span class="n">no4</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">uj</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="linenos">50</span><span class="w">                </span><span class="p">}</span>
<span class="linenos">51</span><span class="w">              </span><span class="p">}</span>
<span class="linenos">52</span><span class="w">              </span><span class="c1">// Do the summation loop</span>
<span class="linenos">53</span><span class="w">              </span><span class="n">v4d_t</span><span class="w"> </span><span class="n">sum</span><span class="p">[</span><span class="n">XB</span><span class="p">][</span><span class="n">YB</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mi">0</span><span class="p">};</span>
<span class="linenos">54</span><span class="w">              </span><span class="k">for</span><span class="p">(</span><span class="kt">long</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kk</span><span class="p">;</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">klim</span><span class="p">;</span><span class="w"> </span><span class="n">k</span><span class="o">++</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">55</span><span class="w">                </span><span class="cp">#pragma GCC unroll xB</span>
<span class="linenos">56</span><span class="w">                </span><span class="k">for</span><span class="p">(</span><span class="kt">long</span><span class="w"> </span><span class="n">ui</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">ui</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">xB</span><span class="p">;</span><span class="w"> </span><span class="n">ui</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">57</span><span class="w">                  </span><span class="cp">#pragma GCC unroll yB</span>
<span class="linenos">58</span><span class="w">                  </span><span class="k">for</span><span class="p">(</span><span class="kt">long</span><span class="w"> </span><span class="n">uj</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">uj</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">yB</span><span class="p">;</span><span class="w"> </span><span class="n">uj</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">59</span><span class="w">                    </span><span class="n">sum</span><span class="p">[</span><span class="n">ui</span><span class="p">][</span><span class="n">uj</span><span class="p">]</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">b</span><span class="p">[(</span><span class="n">i</span><span class="o">+</span><span class="n">ui</span><span class="p">)</span><span class="o">*</span><span class="n">n</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">k</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">vcT</span><span class="p">[(</span><span class="n">j</span><span class="o">-</span><span class="n">jj</span><span class="o">+</span><span class="n">uj</span><span class="p">)</span><span class="o">*</span><span class="n">koff</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">k</span><span class="o">-</span><span class="n">kk</span><span class="p">];</span>
<span class="linenos">60</span><span class="w">                  </span><span class="p">}</span>
<span class="linenos">61</span><span class="w">                </span><span class="p">}</span>
<span class="linenos">62</span><span class="w">              </span><span class="p">}</span>
<span class="linenos">63</span><span class="w">              </span><span class="c1">// Update the a matrix</span>
<span class="linenos">64</span><span class="w">              </span><span class="k">if</span><span class="p">(</span><span class="n">kk</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">65</span><span class="w">                </span><span class="c1">// First k block so we have no previous sum to add to</span>
<span class="linenos">66</span><span class="w">                </span><span class="cp">#pragma GCC unroll 2</span>
<span class="linenos">67</span><span class="w">                </span><span class="k">for</span><span class="p">(</span><span class="kt">long</span><span class="w"> </span><span class="n">ui</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">ui</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">xB</span><span class="p">;</span><span class="w"> </span><span class="n">ui</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">68</span><span class="w">                  </span><span class="cp">#pragma GCC unroll yB</span>
<span class="linenos">69</span><span class="w">                  </span><span class="k">for</span><span class="p">(</span><span class="kt">long</span><span class="w"> </span><span class="n">uj</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">uj</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">yB</span><span class="p">;</span><span class="w"> </span><span class="n">uj</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">70</span><span class="w">                    </span><span class="n">va</span><span class="p">[(</span><span class="n">i</span><span class="o">+</span><span class="n">ui</span><span class="p">)</span><span class="o">*</span><span class="n">no4</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">uj</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sum</span><span class="p">[</span><span class="n">ui</span><span class="p">][</span><span class="n">uj</span><span class="p">];</span>
<span class="linenos">71</span><span class="w">                  </span><span class="p">}</span>
<span class="linenos">72</span><span class="w">                </span><span class="p">}</span>
<span class="linenos">73</span><span class="w">              </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">74</span><span class="w">                </span><span class="c1">// We will add the results of the k-loop to the previous partial sums</span>
<span class="linenos">75</span><span class="w">                </span><span class="cp">#pragma GCC unroll 2</span>
<span class="linenos">76</span><span class="w">                </span><span class="k">for</span><span class="p">(</span><span class="kt">long</span><span class="w"> </span><span class="n">ui</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">ui</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">xB</span><span class="p">;</span><span class="w"> </span><span class="n">ui</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">77</span><span class="w">                  </span><span class="cp">#pragma GCC unroll yB</span>
<span class="linenos">78</span><span class="w">                  </span><span class="k">for</span><span class="p">(</span><span class="kt">long</span><span class="w"> </span><span class="n">uj</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">uj</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">yB</span><span class="p">;</span><span class="w"> </span><span class="n">uj</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="linenos">79</span><span class="w">                    </span><span class="n">va</span><span class="p">[(</span><span class="n">i</span><span class="o">+</span><span class="n">ui</span><span class="p">)</span><span class="o">*</span><span class="n">no4</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">uj</span><span class="p">]</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">sum</span><span class="p">[</span><span class="n">ui</span><span class="p">][</span><span class="n">uj</span><span class="p">];</span>
<span class="linenos">80</span><span class="w">                  </span><span class="p">}</span>
<span class="linenos">81</span><span class="w">                </span><span class="p">}</span>
<span class="linenos">82</span><span class="w">              </span><span class="p">}</span>
<span class="linenos">83</span><span class="w">            </span><span class="p">}</span>
<span class="linenos">84</span><span class="w">          </span><span class="p">}</span>
<span class="linenos">85</span><span class="w">        </span><span class="p">}</span>
<span class="linenos">86</span><span class="w">      </span><span class="p">}</span>
<span class="linenos">87</span><span class="w">    </span><span class="p">}</span>
<span class="linenos">88</span><span class="w">  </span><span class="p">}</span>
<span class="linenos">89</span><span class="p">}</span>
</pre></div>
</div>
<div class="admonition-exercise exercise important admonition" id="exercise-12">
<p class="admonition-title">Exercise</p>
<p>Explore the performance effect of cache and register blocking!
Compile with</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>gcc<span class="w"> </span>-O3<span class="w"> </span>-march<span class="o">=</span>native<span class="w"> </span>-o<span class="w"> </span>mmDx<span class="w"> </span>ex-mm-explicit.c<span class="w"> </span>ex-mm-main.c<span class="w"> </span>-lm
</pre></div>
</div>
<p>Do we get any performance difference? Do not forget that the code only
supports matrix sizes that are multiples of 16!</p>
</div>
<div class="admonition-solution solution important dropdown admonition" id="solution-12">
<p class="admonition-title">Solution</p>
<p>On the Core i7-8550U, we get the following:</p>
<img alt="../_images/mm6-cpi.png" class="align-center" src="../_images/mm6-cpi.png" />
<p>We are now fairly close to the ideal performance of 0.125 cycles per
scalar <code class="docutils literal notranslate"><span class="pre">fma</span></code>, with achieved performance varying from just over 0.15
to around 0.188.</p>
</div>
</section>
<section id="further-reads">
<h2>Further reads<a class="headerlink" href="#further-reads" title="Permalink to this heading"></a></h2>
<ul class="simple">
<li><p>David Spuler. “Efficient Modern C++ Data Structures: Container and Algorithm Optimizations”, 1st Edition. Self-published. 2025.</p></li>
<li><p>Samuel Williams, Andrew Waterman, and David Patterson. “Roofline: An Insightful Visual Performance Model for Multicore Architectures”. Communications of the ACM. 52 (4), pages 65–76.  2009.</p></li>
<li><p>Georg Ofenbeck, Ruedi Steinmann, Victoria Caparros, Daniele G. Spampinato, and Markus Püschel. “Applying the roofline model”. IEEE International Symposium on Performance Analysis of Systems and Software (ISPASS). 2014.</p></li>
</ul>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="../architecture/" class="btn btn-neutral float-left" title="Architecture" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="../quick-reference/" class="btn btn-neutral float-right" title="Quick Reference" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2021, The contributors.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>